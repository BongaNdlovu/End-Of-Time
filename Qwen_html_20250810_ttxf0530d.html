<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Time Prayer Network</title>
    <link rel="stylesheet" href="prayer-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <video id="background-video" src="background.mp4" autoplay loop muted playsinline></video>
    <div class="app-container">
        <!-- Horizontal Nav -->
        <nav class="navbar">
            <div class="nav-brand">
                <img src="Fear God.png" alt="Fear God Imprints Logo" class="logo logo-pulse" style="height:28px;">
                <span class="title">End of Time Prayer Network</span>
            </div>
            <div class="nav-links">
                <a href="#" id="nav-home-link">Home</a>
                <a href="#" id="nav-about-link">My Prayers</a>
                <a href="#" id="nav-wall-link">Prayer Wall</a>
            </div>
            <div class="nav-cta">
                <button class="cta-btn" id="hub-menu-btn" title="Back to Hub"><i class="fas fa-home"></i></button>
                <div style="position:relative;">
                    <button class="notif-btn" id="notif-bell"><i class="fas fa-bell"></i><span class="notif-badge" id="notif-count" style="display:none;">0</span></button>
                    <div class="notif-panel" id="notif-panel"></div>
                </div>
                <button class="cta-btn" id="notif-settings-btn" title="Notification Settings"><i class="fas fa-sliders-h"></i></button>
                <button class="cta-btn" id="nav-submit-btn">Submit Prayer</button>
                <button class="cta-btn" id="signout-btn" title="Sign Out" style="display:none;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <!-- Hero -->
        <section class="hero">
            <h1>A <span class="accent">Global Community</span> United in <span class="accent">Prayer</span></h1>
            <p>In these final moments, let us stand together. Share your burdens, lift up others, and find strength in our collective faith. <strong>YOU ARE NOT ALONE.</strong></p>
            <div class="hero-cta">
                <button class="pill-btn" id="hero-view-wall">View the Prayer Wall</button>
            </div>
        </section>

        <!-- Notification Settings Modal -->
        <div class="modal-backdrop" id="settings-modal" style="display:none;">
            <div class="modal-card" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">Settings</div>
                    <button class="close-x" id="settings-close">Close</button>
                </div>
                
                <!-- Settings Tabs -->
                <div class="settings-tabs" style="display:flex; border-bottom:1px solid var(--border); margin-bottom:20px;">
                    <button class="settings-tab active" data-settings-tab="notifications" style="flex:1; padding:10px; background:transparent; border:none; color:#fff; cursor:pointer; border-bottom:2px solid #4CAF50;">Notifications</button>
                    <button class="settings-tab" data-settings-tab="reminders" style="flex:1; padding:10px; background:transparent; border:none; color:#999; cursor:pointer; border-bottom:2px solid transparent;">Prayer Reminders</button>
                </div>
                
                <!-- Notifications Tab -->
                <div class="settings-tab-content active" id="notifications-settings">
                    <div class="form-row">
                        <label for="settings-email">Email</label>
                        <input type="email" id="settings-email" placeholder="you@example.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;">
                    </div>
                    <div class="form-row">
                        <label>Enable Email Alerts</label>
                        <label class="switch"><input type="checkbox" id="settings-notify-email"> <span>Get email when someone prays for you</span></label>
                    </div>
                    <div class="form-row">
                        <label>Weekly Summary</label>
                        <label class="switch"><input type="checkbox" id="settings-weekly-summary"> <span>Receive weekly prayer summary</span></label>
                    </div>
                    <div class="form-row">
                        <label>Enable Push Alerts</label>
                        <label class="switch"><input type="checkbox" id="settings-notify-push"> <span>Browser notifications</span></label>
                    </div>
                </div>
                
                <!-- Prayer Reminders Tab -->
                <div class="settings-tab-content" id="reminders-settings" style="display:none;">
                    <div class="reminders-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h3 style="margin:0; color:#fff;">Your Prayer Reminders</h3>
                            <p style="margin:5px 0 0 0; color:#999; font-size:14px;">Set up reminders to help maintain your prayer habits</p>
                        </div>
                        <button class="cta-btn" id="add-reminder-btn"><i class="fas fa-plus"></i> Add Reminder</button>
                    </div>
                    
                    <div id="reminders-list">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading your reminders...
                        </div>
                    </div>
                    
                    <!-- Quick Setup Options -->
                    <div class="quick-setup" style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px;">
                        <h4 style="margin:0 0 10px 0; color:#fff; font-size:14px;">Quick Setup</h4>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="quick-reminder-btn" data-time="09:00" data-title="Morning Prayer" style="padding:8px 12px; background:#4CAF50; border:none; border-radius:6px; color:white; font-size:12px; cursor:pointer;">Morning (9 AM)</button>
                            <button class="quick-reminder-btn" data-time="12:00" data-title="Midday Prayer" style="padding:8px 12px; background:#2196F3; border:none; border-radius:6px; color:white; font-size:12px; cursor:pointer;">Lunch (12 PM)</button>
                            <button class="quick-reminder-btn" data-time="18:00" data-title="Evening Prayer" style="padding:8px 12px; background:#FF9800; border:none; border-radius:6px; color:white; font-size:12px; cursor:pointer;">Evening (6 PM)</button>
                            <button class="quick-reminder-btn" data-time="21:00" data-title="Night Prayer" style="padding:8px 12px; background:#9C27B0; border:none; border-radius:6px; color:white; font-size:12px; cursor:pointer;">Night (9 PM)</button>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                    <button class="save-btn" id="settings-save">Save All Settings</button>
                </div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div class="modal-backdrop" id="auth-modal" style="display:flex;">
            <div class="modal-card">
                <div class="modal-header">
                    <div class="modal-title">Sign In to Prayer Network</div>
                </div>
                <div id="auth-content">
                    <!-- Sign In Form -->
                    <div id="signin-form">
                        <div class="form-row">
                            <label for="signin-email">Email</label>
                            <input type="email" id="signin-email" placeholder="your@email.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signin-password">Password</label>
                            <input type="password" id="signin-password" placeholder="Your password" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px;">
                            <button class="save-btn" id="signin-btn">Sign In</button>
                            <button class="save-btn" id="show-signup" style="background:transparent;border:1px solid var(--border);">Create Account</button>
                        </div>
                    </div>

                    <!-- Sign Up Form -->
                    <div id="signup-form" style="display:none;">
                        <div class="form-row">
                            <label for="signup-name">Display Name</label>
                            <input type="text" id="signup-name" placeholder="Your name" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" placeholder="your@email.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" placeholder="Choose a password" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signup-confirm">Confirm Password</label>
                            <input type="password" id="signup-confirm" placeholder="Confirm password" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px;">
                            <button class="save-btn" id="signup-btn">Create Account</button>
                            <button class="save-btn" id="show-signin" style="background:transparent;border:1px solid var(--border);">Back to Sign In</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prayer Reminder Modal -->
        <div class="modal-backdrop" id="reminder-modal" style="display:none;">
            <div class="modal-card" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title" id="reminder-modal-title">Create Prayer Reminder</div>
                    <button class="close-x" id="reminder-close">Close</button>
                </div>
                <form id="reminder-form">
                    <div class="form-row">
                        <label for="reminder-title">Reminder Title</label>
                        <input type="text" id="reminder-title" placeholder="e.g., Morning Prayer Time" maxlength="50" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                    </div>
                    
                    <div class="form-row">
                        <label for="reminder-description">Description (Optional)</label>
                        <textarea id="reminder-description" placeholder="What would you like to be reminded about?" maxlength="200" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;min-height:60px;"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <label for="reminder-time">Time</label>
                        <input type="time" id="reminder-time" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                    </div>
                    
                    <div class="form-row">
                        <label for="reminder-frequency">Frequency</label>
                        <select id="reminder-frequency" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;">
                            <option value="daily">Daily</option>
                            <option value="weekdays">Weekdays (Mon-Fri)</option>
                            <option value="weekends">Weekends (Sat-Sun)</option>
                            <option value="weekly">Weekly</option>
                            <option value="custom">Custom Days</option>
                        </select>
                    </div>
                    
                    <!-- Custom Days Selection -->
                    <div class="form-row" id="custom-days-row" style="display:none;">
                        <label>Select Days</label>
                        <div class="days-selector" style="display:flex; gap:8px; flex-wrap:wrap;">
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="0" style="margin:0;"> Sun
                            </label>
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="1" style="margin:0;"> Mon
                            </label>
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="2" style="margin:0;"> Tue
                            </label>
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="3" style="margin:0;"> Wed
                            </label>
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="4" style="margin:0;"> Thu
                            </label>
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="5" style="margin:0;"> Fri
                            </label>
                            <label class="day-checkbox" style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#444; border-radius:6px; cursor:pointer; user-select:none;">
                                <input type="checkbox" value="6" style="margin:0;"> Sat
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="reminder-prayer-list">Prayer List (Optional)</label>
                        <select id="reminder-prayer-list" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;">
                            <option value="">General Reminder</option>
                            <!-- Prayer lists will be loaded here -->
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <label>Reminder Options</label>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label class="switch"><input type="checkbox" id="reminder-sound" checked> <span>Play sound</span></label>
                            <label class="switch"><input type="checkbox" id="reminder-snooze" checked> <span>Allow snooze (10 minutes)</span></label>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; gap:10px; margin-top:20px;">
                        <button type="button" class="save-btn" id="delete-reminder-btn" style="background:#e74c3c;display:none;">Delete Reminder</button>
                        <button type="submit" class="save-btn" id="save-reminder-btn">Create Reminder</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Prayer List Management Modal -->
        <div class="modal-backdrop" id="prayer-list-modal" style="display:none;">
            <div class="modal-card">
                <div class="modal-header">
                    <div class="modal-title" id="prayer-list-modal-title">Create New Prayer List</div>
                    <button class="close-x" id="prayer-list-close">Close</button>
                </div>
                <form id="prayer-list-form">
                    <div class="form-row">
                        <label for="list-name">List Name</label>
                        <input type="text" id="list-name" placeholder="e.g., Family Prayers" maxlength="50" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                    </div>
                    <div class="form-row">
                        <label for="list-description">Description (Optional)</label>
                        <textarea id="list-description" placeholder="What kind of prayers will you add to this list?" maxlength="200" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;min-height:80px;"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="list-color">Color Theme</label>
                        <div class="color-picker" style="display:flex;gap:10px;flex-wrap:wrap;">
                            <div class="color-option" data-color="#4CAF50" style="width:30px;height:30px;border-radius:50%;background:#4CAF50;cursor:pointer;border:2px solid transparent;"></div>
                            <div class="color-option" data-color="#2196F3" style="width:30px;height:30px;border-radius:50%;background:#2196F3;cursor:pointer;border:2px solid transparent;"></div>
                            <div class="color-option" data-color="#FF9800" style="width:30px;height:30px;border-radius:50%;background:#FF9800;cursor:pointer;border:2px solid transparent;"></div>
                            <div class="color-option" data-color="#9C27B0" style="width:30px;height:30px;border-radius:50%;background:#9C27B0;cursor:pointer;border:2px solid transparent;"></div>
                            <div class="color-option" data-color="#F44336" style="width:30px;height:30px;border-radius:50%;background:#F44336;cursor:pointer;border:2px solid transparent;"></div>
                            <div class="color-option" data-color="#607D8B" style="width:30px;height:30px;border-radius:50%;background:#607D8B;cursor:pointer;border:2px solid transparent;"></div>
                        </div>
                        <input type="hidden" id="list-color" value="#4CAF50">
                    </div>
                    <div class="form-row">
                        <label for="list-icon">Icon</label>
                        <div class="icon-picker" style="display:flex;gap:10px;flex-wrap:wrap;">
                            <div class="icon-option" data-icon="fas fa-heart" style="width:40px;height:40px;border-radius:8px;background:#444;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-heart"></i></div>
                            <div class="icon-option" data-icon="fas fa-family" style="width:40px;height:40px;border-radius:8px;background:#444;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-users"></i></div>
                            <div class="icon-option" data-icon="fas fa-briefcase" style="width:40px;height:40px;border-radius:8px;background:#444;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-briefcase"></i></div>
                            <div class="icon-option" data-icon="fas fa-cross" style="width:40px;height:40px;border-radius:8px;background:#444;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-cross"></i></div>
                            <div class="icon-option" data-icon="fas fa-book" style="width:40px;height:40px;border-radius:8px;background:#444;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-book"></i></div>
                            <div class="icon-option" data-icon="fas fa-globe" style="width:40px;height:40px;border-radius:8px;background:#444;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-globe"></i></div>
                        </div>
                        <input type="hidden" id="list-icon" value="fas fa-heart">
                    </div>
                    <div style="display:flex; justify-content:space-between; gap:10px; margin-top:20px;">
                        <button type="button" class="save-btn" id="delete-list-btn" style="background:#e74c3c;display:none;">Delete List</button>
                        <button type="submit" class="save-btn" id="save-list-btn">Create List</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Prayer Feed Tab -->
            <div class="tab-content active" id="feedTab">
                <!-- Stats Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Your Spiritual Growth</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Prayers Shared</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Prayers Prayed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Answered</div>
                        </div>
                    </div>
                </div>
                
                <!-- Streak Card -->
                <div class="card">
                    <div class="streak-container">
                        <div class="streak-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="streak-info">
                            <div class="streak-title">Current Prayer Streak</div>
                            <div class="streak-count">0 Days</div>
                            <div class="streak-desc">Keep praying to maintain your streak!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Prayer requests will be dynamically added here -->
            </div>
            
            <!-- Submit Prayer Tab -->
            <div class="tab-content" id="submitTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Share Your Prayer Request</div>
                    </div>
                    <form id="prayerForm">
                        <div class="form-group">
                            <label class="form-label">Prayer Title</label>
                            <input type="text" class="form-input" placeholder="Brief description of your request" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prayer Description</label>
                            <textarea class="form-textarea" placeholder="Share more details about your request..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select">
                                <option value="">Select a category</option>
                                <option value="health">Health</option>
                                <option value="family">Family</option>
                                <option value="spiritual">Spiritual Growth</option>
                                <option value="financial">Financial</option>
                                <option value="career">Career</option>
                                <option value="mission">Mission/Outreach</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Urgency Level</label>
                            <select class="form-select">
                                <option value="ongoing">Ongoing</option>
                                <option value="week">This Week</option>
                                <option value="immediate">Immediate</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Add to Prayer List (Optional)</label>
                            <select class="form-select" id="prayer-list-select">
                                <option value="">None - Community Prayer Only</option>
                                <!-- Prayer lists will be loaded here -->
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="anonymous">
                            <label for="anonymous">Submit anonymously</label>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Submit Prayer Request
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- My Prayer Lists Tab -->
            <div class="tab-content" id="prayerListsTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Prayer Lists</div>
                        <button class="cta-btn" id="add-list-btn"><i class="fas fa-plus"></i> New List</button>
                    </div>
                    <div id="prayer-lists-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading your prayer lists...
                        </div>
                    </div>
                </div>
                
                <!-- Selected List Prayers -->
                <div class="card" id="list-prayers-card" style="display: none;">
                    <div class="card-header">
                        <div class="card-title" id="list-prayers-title">List Prayers</div>
                        <button class="cta-btn" id="add-prayer-to-list-btn"><i class="fas fa-plus"></i> Add Prayer</button>
                    </div>
                    <div id="list-prayers-container">
                        <!-- Prayers for selected list will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboardTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Your Prayer History</div>
                    </div>
                    <div id="user-prayers-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading your prayers...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Answered Prayers</div>
                    </div>
                    <div id="answered-prayers-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading answered prayers...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="feedTab">
                <i class="fas fa-home"></i>
                <div>Feed</div>
            </div>
            <div class="nav-tab" data-tab="prayerListsTab">
                <i class="fas fa-list"></i>
                <div>My Lists</div>
            </div>
            <div class="nav-tab" data-tab="submitTab">
                <i class="fas fa-plus-circle"></i>
                <div>Submit</div>
            </div>
            <div class="nav-tab" data-tab="dashboardTab">
                <i class="fas fa-chart-line"></i>
                <div>Dashboard</div>
            </div>
        </div>
    </div>

    <script>
        // Suppress browser extension errors
        window.addEventListener('error', function(e) {
            if (e.filename && (e.filename.includes('chrome-extension://') || e.filename.includes('moz-extension://'))) {
                e.preventDefault();
                return true;
            }
            // Also suppress if error message contains extension-related keywords
            if (e.message && (e.message.includes('chrome-extension') || e.message.includes('content_script') || e.message.includes('getBestMatchFromCodes'))) {
                e.preventDefault();
                return true;
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && (e.reason.toString().includes('chrome-extension') || e.reason.toString().includes('content_script'))) {
                e.preventDefault();
                return true;
            }
        });

        // Handle any message events properly
        if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.onMessage) {
            chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
                return true;
            });
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA78bvzjP-b7K9TPCbIL3ttzPJr07VR8kY",
            authDomain: "end-of-time-94cd3.firebaseapp.com",
            projectId: "end-of-time-94cd3",
            storageBucket: "end-of-time-94cd3.firebasestorage.app",
            messagingSenderId: "628602476853",
            appId: "1:628602476853:web:181df03c3374465811147c",
            measurementId: "G-E5R3NG1533"
        };

        let auth, db;
        let currentUser = null;
        let activeUnsub = null;
        
        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('✅ Firebase initialized for Prayer Network');
        } catch (e) {
            console.error('❌ Firebase initialization failed:', e);
        }

        // Authentication Functions
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        function initAuth() {
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const showSignup = document.getElementById('show-signup');
            const showSignin = document.getElementById('show-signin');
            const signinBtn = document.getElementById('signin-btn');
            const signupBtn = document.getElementById('signup-btn');
            const signoutBtn = document.getElementById('signout-btn');

            // Toggle between signin and signup forms
            showSignup.addEventListener('click', () => {
                signinForm.style.display = 'none';
                signupForm.style.display = 'block';
            });

            showSignin.addEventListener('click', () => {
                signupForm.style.display = 'none';
                signinForm.style.display = 'block';
            });

            // Sign in functionality
            signinBtn.addEventListener('click', async () => {
                const email = document.getElementById('signin-email').value.trim();
                const password = document.getElementById('signin-password').value;

                if (!email || !password) {
                    showError('Please enter both email and password');
                    return;
                }

                signinBtn.disabled = true;
                signinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showSuccess('Welcome back! You are now signed in.');
                    hideAuthModal();
                } catch (error) {
                    console.error('Sign in error:', error);
                    showError(getAuthErrorMessage(error.code));
                } finally {
                    signinBtn.disabled = false;
                    signinBtn.innerHTML = 'Sign In';
                }
            });

            // Sign up functionality
            signupBtn.addEventListener('click', async () => {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm').value;

                if (!name || !email || !password || !confirmPassword) {
                    showError('Please fill in all fields');
                    return;
                }

                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }

                if (password.length < 6) {
                    showError('Password must be at least 6 characters long');
                    return;
                }

                signupBtn.disabled = true;
                signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    
                    // Create user document in Firestore
                    await db.collection('users').doc(userCredential.user.uid).set({
                        displayName: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        notifyEmail: true,
                        weeklySummary: true,
                        notifyPush: true
                    });

                    showSuccess('Account created successfully! Welcome to the Prayer Network.');
                    hideAuthModal();
                } catch (error) {
                    console.error('Sign up error:', error);
                    showError(getAuthErrorMessage(error.code));
                } finally {
                    signupBtn.disabled = false;
                    signupBtn.innerHTML = 'Create Account';
                }
            });

            // Sign out functionality
            signoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    showSuccess('You have been signed out');
                } catch (error) {
                    console.error('Sign out error:', error);
                    showError('Failed to sign out');
                }
            });
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address';
                case 'auth/wrong-password':
                    return 'Incorrect password';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists';
                case 'auth/weak-password':
                    return 'Password is too weak';
                case 'auth/invalid-email':
                    return 'Invalid email address';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later';
                default:
                    return 'Authentication failed. Please try again';
            }
        }

        function updateUIForAuthState(user) {
            const authModal = document.getElementById('auth-modal');
            const signoutBtn = document.getElementById('signout-btn');
            const navSubmitBtn = document.getElementById('nav-submit-btn');
            const navSettingsBtn = document.getElementById('notif-settings-btn');

            if (user) {
                // User is signed in
                authModal.style.display = 'none';
                signoutBtn.style.display = 'block';
                navSubmitBtn.style.display = 'block';
                navSettingsBtn.style.display = 'block';
            } else {
                // User is signed out
                authModal.style.display = 'flex';
                signoutBtn.style.display = 'none';
                navSubmitBtn.style.display = 'none';
                navSettingsBtn.style.display = 'none';
            }
        }

        // UI Helper Functions
        function setLoading(isLoading) {
            const area = document.getElementById('contentArea');
            if (isLoading) {
                area.setAttribute('aria-busy', 'true');
            } else {
                area.removeAttribute('aria-busy');
            }
        }
        
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            toast.innerHTML = `<i class="fas fa-check" style="margin-right: 8px;"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showError(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            toast.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Email notification function (client-side trigger)
        async function sendEmailNotification(recipientUserId, type, data) {
            if (!recipientUserId) return;
            
            try {
                // Get recipient's email preferences
                const userDoc = await db.collection('users').doc(recipientUserId).get();
                const userData = userDoc.data();
                
                if (userData && userData.notifyEmail && userData.email) {
                    // Store email notification request in Firestore for backend processing
                    await db.collection('emailQueue').add({
                        to: userData.email,
                        type: type,
                        data: data,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    });
                    console.log('Email notification queued');
                }
            } catch (e) {
                console.log('Could not queue email notification:', e);
            }
        }

        // Render prayers function with comments fix
        function renderPrayers(snapshotDocs, currentUid) {
            const feed = document.getElementById('feedTab');
            
            // Keep the first two cards (stats and streak)
            const staticCards = feed.querySelectorAll('.card');
            const cardsToKeep = Array.from(staticCards).slice(0, 2);
            
            // Clear everything else
            feed.innerHTML = '';
            cardsToKeep.forEach(card => feed.appendChild(card));

            if (snapshotDocs.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'card';
                emptyState.style.textAlign = 'center';
                emptyState.style.padding = '40px';
                emptyState.innerHTML = `
                    <i class="fas fa-praying-hands" style="font-size: 3rem; color: #999; margin-bottom: 1rem;"></i>
                    <p style="color: #999; font-size: 1.1rem;">No prayers yet. Be the first to share!</p>
                `;
                feed.appendChild(emptyState);
                return;
            }

            snapshotDocs.forEach(doc => {
                const p = doc.data();
                const isOwner = p.userId === currentUid;
                const isAnon = p.isAnonymous === true && !isOwner;
                const displayName = isAnon ? 'Anonymous' : (p.userDisplayName || 'User');

                const wrapper = document.createElement('div');
                wrapper.className = 'prayer-request card' + (isAnon ? ' anonymous' : '');
                wrapper.innerHTML = `
                    <div class="prayer-user">
                        <div class="avatar">${(displayName||'U').substring(0,2)}</div>
                        <div class="user-info">
                            <div class="user-name">${displayName}</div>
                            <div class="request-time">${p.createdAt ? new Date(p.createdAt.toDate()).toLocaleString() : 'Just now'}</div>
                        </div>
                        <div class="urgency-tag ${p.urgency ? `urgency-${p.urgency}`: ''}">${p.urgency || 'General'}</div>
                    </div>
                    <div class="prayer-content">
                        <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                        <div class="prayer-description">${p.description || ''}</div>
                    </div>
                    <div class="prayer-meta">
                        <div class="category-tag">${p.category || 'General'}</div>
                        ${p.status === 'answered' ? '<div style="color: var(--success); font-weight: 600;">✓ Answered</div>' : ''}
                    </div>
                    <div class="prayer-actions">
                        <button class="action-btn pray-btn"><i class="fas fa-pray"></i> I Prayed</button>
                        <button class="action-btn toggle-comments"><i class="fas fa-comment"></i> Comments (<span class="comment-count">0</span>)</button>
                        ${isOwner 
                            ? `<button class="action-btn toggle-status">${p.status === 'answered' ? '<i class="fas fa-undo"></i> Mark Ongoing' : '<i class="fas fa-check-circle"></i> Mark Answered'}</button>
                               <button class="action-btn delete-prayer" style="background: rgba(231,76,60,0.2); color: #e74c3c; border-color: #e74c3c;"><i class="fas fa-trash"></i> Delete</button>`
                            : ''}
                    </div>
                    <div class="comments-container" style="display:none;margin-top:10px;">
                        <div class="comments-list" style="background: rgba(255,255,255,0.05); padding:10px; border-radius:8px; border:1px solid var(--border); max-height: 200px; overflow-y: auto;"></div>
                        <form class="comment-form" style="display:flex; gap:8px; margin-top:8px;">
                            <input type="text" placeholder="Write a comment..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:#333; color:#fff;">
                            <button class="action-btn" type="submit" style="flex:0 0 auto;">Post</button>
                        </form>
                    </div>`;

                // Wire up the pray button
                const prayBtn = wrapper.querySelector('.pray-btn');
                const commentCount = wrapper.querySelector('.comment-count');

                // Update comment count
                db.collection('prayers').doc(doc.id).collection('interactions')
                    .where('type', '==', 'comment')
                    .onSnapshot(snapshot => {
                        commentCount.textContent = snapshot.size;
                    });

                // Check if current user already prayed
                if (currentUid) {
                    db.collection('prayers').doc(doc.id).collection('interactions')
                        .where('type', '==', 'prayed')
                        .where('userId', '==', currentUid)
                        .get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                prayBtn.innerHTML = '<i class="fas fa-check"></i> You Prayed';
                                prayBtn.classList.add('answered');
                                prayBtn.disabled = true;
                            }
                        });
                }

                prayBtn.addEventListener('click', async () => {
                    if (prayBtn.disabled) return;
                    
                    prayBtn.disabled = true;
                    const originalText = prayBtn.innerHTML;
                    prayBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Praying...';

                    try {
                        const userName = currentUser ? (currentUser.displayName || currentUser.email || 'Anonymous') : 'Anonymous';
                        
                        await db.collection('prayers').doc(doc.id).collection('interactions').add({
                            type: 'prayed',
                            userId: currentUid || null,
                            userDisplayName: userName,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        
                        prayBtn.innerHTML = '<i class="fas fa-check"></i> You Prayed';
                        prayBtn.classList.add('answered');
                        
                        showSuccess('Thank you for your prayers! God bless you.');
                        
                        // Create notification and trigger email
                        if (p.userId && p.userId !== currentUid) {
                            try {
                                await db.collection('notifications').add({
                                    userId: p.userId,
                                    type: 'prayed',
                                    prayerId: doc.id,
                                    prayerTitle: p.title,
                                    actorId: currentUid || null,
                                    actorName: userName,
                                    message: `${userName} is praying for your request: "${p.title}"`,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    read: false,
                                });
                                
                                // Send email notification
                                await sendEmailNotification(p.userId, 'prayer_received', {
                                    prayerTitle: p.title,
                                    userName: userName,
                                    message: `${userName} is lifting you up in prayer for "${p.title}". You are not alone in this journey.`
                                });
                            } catch(e) {
                                console.log('Notification creation failed:', e);
                            }
                        }
                    } catch (e) {
                        console.error('Prayer interaction error:', e);
                        prayBtn.innerHTML = originalText;
                        prayBtn.disabled = false;
                        showError('Unable to record your prayer. Please try again.');
                    }
                });

                // Toggle status button for owners
                const toggleStatus = wrapper.querySelector('.toggle-status');
                if (toggleStatus) {
                    toggleStatus.addEventListener('click', async () => {
                        try {
                            const newStatus = p.status === 'answered' ? 'ongoing' : 'answered';
                            await db.collection('prayers').doc(doc.id).update({ 
                                status: newStatus, 
                                answeredAt: newStatus === 'answered' ? firebase.firestore.FieldValue.serverTimestamp() : null,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            showSuccess(`Prayer marked as ${newStatus}`);
                            toggleStatus.innerHTML = newStatus === 'answered' 
                                ? '<i class="fas fa-undo"></i> Mark Ongoing' 
                                : '<i class="fas fa-check-circle"></i> Mark Answered';
                        } catch (e) { 
                            console.error(e); 
                            showError('Failed to update status'); 
                        }
                    });
                }

                // Delete button for owners
                const deleteBtn = wrapper.querySelector('.delete-prayer');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this prayer request? This action cannot be undone.')) {
                            try {
                                // Delete all interactions first
                                const interactions = await db.collection('prayers').doc(doc.id).collection('interactions').get();
                                const batch = db.batch();
                                interactions.forEach(interDoc => {
                                    batch.delete(interDoc.ref);
                                });
                                await batch.commit();
                                
                                // Then delete the prayer
                                await db.collection('prayers').doc(doc.id).delete();
                                showSuccess('Prayer request deleted successfully');
                            } catch (e) {
                                console.error('Delete error:', e);
                                showError('Failed to delete prayer request');
                            }
                        }
                    });
                }

                // Comments functionality
                const commentsContainer = wrapper.querySelector('.comments-container');
                const toggleComments = wrapper.querySelector('.toggle-comments');
                const commentsList = wrapper.querySelector('.comments-list');
                const commentForm = wrapper.querySelector('.comment-form');
                // use existing commentCount from outer scope
                
                // Load and display comments
                let commentsLoaded = false;
                
                function loadComments() {
                    db.collection('prayers').doc(doc.id).collection('interactions')
                        .where('type', '==', 'comment')
                        .orderBy('createdAt', 'asc')
                        .onSnapshot(snapshot => {
                            commentCount.textContent = snapshot.size;
                            commentsList.innerHTML = '';
                            
                            if (snapshot.empty) {
                                commentsList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">No comments yet. Be the first to encourage!</div>';
                            } else {
                                snapshot.forEach(commentDoc => {
                                    const comment = commentDoc.data();
                                    const commentDiv = document.createElement('div');
                                    commentDiv.style.cssText = 'margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;';
                                    
                                    const isCommentOwner = comment.userId === currentUid;
                                    commentDiv.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div style="flex: 1;">
                                                <strong style="color: #fff;">${comment.userDisplayName || 'Anonymous'}:</strong>
                                                <span style="color: #ddd; margin-left: 5px;">${comment.text}</span>
                                            </div>
                                            ${isCommentOwner ? `
                                                <button class="delete-comment" data-id="${commentDoc.id}" style="background: transparent; border: none; color: #e74c3c; cursor: pointer; padding: 2px 6px;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #999; margin-top: 4px;">
                                            ${comment.createdAt ? new Date(comment.createdAt.toDate()).toLocaleString() : 'Just now'}
                                        </div>
                                    `;
                                    
                                    // Wire delete button if present
                                    const deleteCommentBtn = commentDiv.querySelector('.delete-comment');
                                    if (deleteCommentBtn) {
                                        deleteCommentBtn.addEventListener('click', async () => {
                                            try {
                                                await db.collection('prayers').doc(doc.id)
                                                    .collection('interactions').doc(commentDoc.id).delete();
                                                showSuccess('Comment deleted');
                                            } catch (e) {
                                                console.error('Delete comment error:', e);
                                                showError('Failed to delete comment');
                                            }
                                        });
                                    }
                                    
                                    commentsList.appendChild(commentDiv);
                                });
                            }
                        });
                }
                
                toggleComments.addEventListener('click', () => {
                    const isOpen = commentsContainer.style.display !== 'none';
                    commentsContainer.style.display = isOpen ? 'none' : 'block';
                    
                    if (!isOpen && !commentsLoaded) {
                        loadComments();
                        commentsLoaded = true;
                    }
                });
                
                // Handle comment submission
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = commentForm.querySelector('input');
                    const text = input.value.trim();
                    
                    if (!text) return;
                    
                    try {
                        const userName = currentUser ? (currentUser.displayName || currentUser.email || 'Anonymous') : 'Anonymous';
                        
                        await db.collection('prayers').doc(doc.id).collection('interactions').add({
                            type: 'comment',
                            userId: currentUid || null,
                            userDisplayName: userName,
                            text: text,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        
                        input.value = '';
                        
                        // Notify prayer owner about the comment
                        if (p.userId && p.userId !== currentUid) {
                            try {
                                await db.collection('notifications').add({
                                    userId: p.userId,
                                    type: 'comment',
                                    prayerId: doc.id,
                                    prayerTitle: p.title,
                                    actorId: currentUid || null,
                                    actorName: userName,
                                    message: `${userName} commented on your prayer: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    read: false,
                                });
                                
                                // Send email notification for comment
                                await sendEmailNotification(p.userId, 'comment_received', {
                                    prayerTitle: p.title,
                                    userName: userName,
                                    comment: text,
                                    message: `${userName} left an encouraging message on your prayer request "${p.title}".`
                                });
                            } catch(e) {
                                console.log('Comment notification failed:', e);
                            }
                        }
                    } catch (e) {
                        console.error('Comment submission error:', e);
                        showError('Failed to post comment. Please try again.');
                    }
                });

                feed.appendChild(wrapper);
            });
        }

        // Tab Navigation
        function initTabNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    const tabId = tab.getAttribute('data-tab');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                        targetTab.style.display = 'flex';
                        targetTab.style.flexDirection = 'column';
                        targetTab.style.gap = '15px';
                        
                        // Load data when switching tabs
                        if (tabId === 'dashboardTab' && currentUser) {
                            loadUserDashboard(currentUser.uid);
                        } else if (tabId === 'prayerListsTab' && currentUser) {
                            loadPrayerLists(currentUser.uid);
                        }
                    }
                });
            });
        }

        // Form submission
        function initFormHandling() {
            const form = document.getElementById('prayerForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const title = form.querySelector('input[type="text"]').value.trim();
                    const description = form.querySelector('textarea').value.trim();
                    const category = form.querySelector('select').value || 'general';
                    const urgency = form.querySelectorAll('select')[1]?.value || 'ongoing';
                    const selectedListId = document.getElementById('prayer-list-select')?.value || '';
                    const isAnonymous = document.getElementById('anonymous')?.checked || false;

                    if (!title) { 
                        showError('Please provide a title for your prayer request.'); 
                        return; 
                    }

                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                    submitBtn.disabled = true;

                    try {
                        const prayerData = {
                            userId: currentUser ? currentUser.uid : null,
                            userDisplayName: currentUser ? (currentUser.displayName || currentUser.email || 'User') : 'Guest',
                            userEmail: currentUser ? currentUser.email : null,
                            title: title, 
                            description: description, 
                            category: category, 
                            urgency: urgency, 
                            isAnonymous: isAnonymous,
                            status: 'ongoing',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            privacy: isAnonymous ? 'anonymous' : 'public',
                            prayedCount: 0,
                            commentCount: 0
                        };

                        const prayerDoc = await db.collection('prayers').add(prayerData);
                        
                        // Add to selected prayer list if one was chosen
                        if (selectedListId) {
                            await addPrayerToList(prayerDoc.id, selectedListId);
                        }
                        
                        showSuccess('Prayer request submitted successfully! The community will lift you up.');
                        form.reset();
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        
                        // Switch to feed tab
                        document.querySelector('[data-tab="feedTab"]').click();
                        
                    } catch (e) { 
                        console.error('Prayer submission error:', e);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        showError('Failed to submit prayer. Please try again.'); 
                    }
                });
            }
            
            // Wire up navbar and hero buttons
            document.getElementById('hero-view-wall')?.addEventListener('click', () => {
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-wall-link')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-home-link')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-about-link')?.addEventListener('click', (e) => {
                e.preventDefault();
                // Switch to dashboard tab and load user's prayers
                document.querySelector('[data-tab="dashboardTab"]').click();
                if (currentUser) {
                    loadUserDashboard(currentUser.uid);
                }
            });
            
            document.getElementById('nav-submit-btn')?.addEventListener('click', () => {
                document.querySelector('[data-tab="submitTab"]').click();
            });
            // Hub button -> go back to hub menu
            document.getElementById('hub-menu-btn')?.addEventListener('click', () => {
                window.location.href = 'menu.html';
            });
            
            // Settings modal
            const modal = document.getElementById('settings-modal');
            document.getElementById('notif-settings-btn')?.addEventListener('click', () => {
                modal.style.display = 'flex';
            });
            document.getElementById('settings-close')?.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }

        // Load only user's prayers
        function loadMyPrayers(uid) {
            if (!uid || !db) {
                showError('Please sign in to view your prayers');
                return;
            }
            
            setLoading(true);
            
            if (activeUnsub) {
                activeUnsub();
                activeUnsub = null;
            }
            
            activeUnsub = db.collection('prayers')
                .where('userId', '==', uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    setLoading(false);
                    renderPrayers(snapshot.docs, uid);
                }, error => {
                    setLoading(false);
                    console.error('Error loading your prayers:', error);
                    showError('Failed to load your prayers');
                });
        }

        // Update user statistics
        function updateUserStats(uid) {
            if (!uid || !db) return;
            
            // Prayers shared
            db.collection('prayers').where('userId', '==', uid).onSnapshot(snapshot => {
                const statCard = document.querySelector('.stat-card:nth-child(1) .stat-value');
                if (statCard) statCard.textContent = snapshot.size;
            });
            
            // Prayers prayed (using collectionGroup)
            db.collectionGroup('interactions')
                .where('type', '==', 'prayed')
                .where('userId', '==', uid)
                .get()
                .then(snapshot => {
                    const statCard = document.querySelector('.stat-card:nth-child(2) .stat-value');
                    if (statCard) statCard.textContent = snapshot.size;
                });
            
            // Answered prayers
            db.collection('prayers')
                .where('userId', '==', uid)
                .where('status', '==', 'answered')
                .onSnapshot(snapshot => {
                    const statCard = document.querySelector('.stat-card:nth-child(3) .stat-value');
                    if (statCard) statCard.textContent = snapshot.size;
                });
            
            // Update streak
            updatePrayerStreak(uid);
        }

        // Calculate prayer streak
        function updatePrayerStreak(uid) {
            if (!uid || !db) return;
            
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            db.collectionGroup('interactions')
                .where('userId', '==', uid)
                .where('type', 'in', ['prayed', 'comment'])
                .where('createdAt', '>=', sevenDaysAgo)
                .get()
                .then(snapshot => {
                    const days = new Set();
                    snapshot.forEach(doc => {
                        const date = doc.data().createdAt?.toDate();
                        if (date) {
                            days.add(date.toDateString());
                        }
                    });
                    
                    const streakElement = document.querySelector('.streak-count');
                    if (streakElement) {
                        streakElement.textContent = `${days.size} Days`;
                    }
                });
        }

        // Load user dashboard
        function loadUserDashboard(uid) {
            if (!uid || !db) return;
            
            const userPrayersContainer = document.getElementById('user-prayers-container');
            const answeredPrayersContainer = document.getElementById('answered-prayers-container');
            
            // Load user's prayers with delete and status toggle
            db.collection('prayers')
                .where('userId', '==', uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        userPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">You haven\'t submitted any prayers yet.</div>';
                        return;
                    }
                    
                    userPrayersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const prayerDiv = document.createElement('div');
                        prayerDiv.className = 'prayer-request';
                        prayerDiv.innerHTML = `
                            <div class="prayer-user">
                                <div class="avatar">You</div>
                                <div class="user-info">
                                    <div class="user-name">Your Prayer</div>
                                    <div class="request-time">${p.createdAt ? new Date(p.createdAt.toDate()).toLocaleDateString() : 'Recently'}</div>
                                </div>
                                <div class="urgency-tag ${p.urgency ? `urgency-${p.urgency}` : ''}">${p.urgency || 'General'}</div>
                            </div>
                            <div class="prayer-content">
                                <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                                <div class="prayer-description">${p.description || ''}</div>
                            </div>
                            <div class="prayer-meta">
                                <div class="category-tag">${p.category || 'General'}</div>
                                ${p.status === 'answered' ? '<div style="color: var(--success); font-weight: 600;">✓ Answered</div>' : ''}
                            </div>
                            <div class="prayer-actions">
                                <button class="action-btn status-toggle" data-id="${doc.id}" data-status="${p.status}">
                                    ${p.status === 'answered' ? '<i class="fas fa-undo"></i> Mark Ongoing' : '<i class="fas fa-check-circle"></i> Mark Answered'}
                                </button>
                                <button class="action-btn delete-btn" data-id="${doc.id}" style="background: rgba(231,76,60,0.2); color: #e74c3c; border-color: #e74c3c;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>`;
                        
                        // Wire status toggle
                        const statusBtn = prayerDiv.querySelector('.status-toggle');
                        statusBtn.addEventListener('click', async () => {
                            const newStatus = statusBtn.dataset.status === 'answered' ? 'ongoing' : 'answered';
                            try {
                                await db.collection('prayers').doc(statusBtn.dataset.id).update({
                                    status: newStatus,
                                    answeredAt: newStatus === 'answered' ? firebase.firestore.FieldValue.serverTimestamp() : null,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                showSuccess(`Prayer marked as ${newStatus}`);
                                loadUserDashboard(uid); // Reload dashboard
                            } catch (e) {
                                console.error('Status update error:', e);
                                showError('Failed to update status');
                            }
                        });
                        
                        // Wire delete button
                        const deleteBtn = prayerDiv.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', async () => {
                            if (confirm('Are you sure you want to delete this prayer? This cannot be undone.')) {
                                try {
                                    // Delete interactions first
                                    const interactions = await db.collection('prayers').doc(deleteBtn.dataset.id).collection('interactions').get();
                                    const batch = db.batch();
                                    interactions.forEach(interDoc => {
                                        batch.delete(interDoc.ref);
                                    });
                                    await batch.commit();
                                    
                                    // Delete prayer
                                    await db.collection('prayers').doc(deleteBtn.dataset.id).delete();
                                    showSuccess('Prayer deleted successfully');
                                    loadUserDashboard(uid); // Reload dashboard
                                } catch (e) {
                                    console.error('Delete error:', e);
                                    showError('Failed to delete prayer');
                                }
                            }
                        });
                        
                        userPrayersContainer.appendChild(prayerDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading prayers:', error);
                    userPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading prayers.</div>';
                });
            
            // Load community answered prayers
            db.collection('prayers')
                .where('status', '==', 'answered')
                .orderBy('answeredAt', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        answeredPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No answered prayers to celebrate yet.</div>';
                        return;
                    }
                    
                    answeredPrayersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const isOwn = p.userId === uid;
                        const prayerDiv = document.createElement('div');
                        prayerDiv.className = 'prayer-request';
                        prayerDiv.innerHTML = `
                            <div class="prayer-user">
                                <div class="avatar">${isOwn ? 'You' : (p.userDisplayName || 'User').substring(0,2)}</div>
                                <div class="user-info">
                                    <div class="user-name">${isOwn ? 'Your Prayer' : (p.userDisplayName || 'User')}</div>
                                    <div class="request-time">Answered ${p.answeredAt ? new Date(p.answeredAt.toDate()).toLocaleDateString() : 'recently'}</div>
                                </div>
                            </div>
                            <div class="prayer-content">
                                <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                                <div class="prayer-description">${p.description || ''}</div>
                            </div>
                            <div class="prayer-meta">
                                <div class="category-tag">${p.category || 'General'}</div>
                                <div style="color: var(--success); font-weight: 600;">✓ Answered - Praise God!</div>
                            </div>`;
                        answeredPrayersContainer.appendChild(prayerDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading answered prayers:', error);
                    answeredPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading answered prayers.</div>';
                });
        }

        // ===== PRAYER LISTS FUNCTIONALITY =====
        
        let currentEditingListId = null;
        let userPrayerLists = [];

        // Initialize default prayer lists for new users
        async function initializeDefaultPrayerLists(uid) {
            if (!uid || !db) return;
            
            try {
                // Check if user already has prayer lists
                const existingLists = await db.collection('prayerLists')
                    .where('userId', '==', uid)
                    .get();
                
                if (!existingLists.empty) return; // User already has lists
                
                const defaultLists = [
                    { name: 'General', description: 'General prayer requests', color: '#607D8B', icon: 'fas fa-heart', isDefault: true, orderIndex: 0 },
                    { name: 'Family', description: 'Prayers for family members', color: '#4CAF50', icon: 'fas fa-users', isDefault: false, orderIndex: 1 },
                    { name: 'Health', description: 'Health and healing prayers', color: '#2196F3', icon: 'fas fa-heartbeat', isDefault: false, orderIndex: 2 },
                    { name: 'Work & Career', description: 'Professional life prayers', color: '#FF9800', icon: 'fas fa-briefcase', isDefault: false, orderIndex: 3 },
                    { name: 'Spiritual Growth', description: 'Personal spiritual development', color: '#9C27B0', icon: 'fas fa-cross', isDefault: false, orderIndex: 4 }
                ];
                
                const batch = db.batch();
                defaultLists.forEach(list => {
                    const docRef = db.collection('prayerLists').doc();
                    batch.set(docRef, {
                        ...list,
                        userId: uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        prayerCount: 0
                    });
                });
                
                await batch.commit();
                console.log('✅ Default prayer lists created for user');
                
            } catch (error) {
                console.error('Error creating default prayer lists:', error);
            }
        }

        // Load user's prayer lists
        function loadPrayerLists(uid) {
            if (!uid || !db) return;
            
            db.collection('prayerLists')
                .where('userId', '==', uid)
                .orderBy('orderIndex', 'asc')
                .onSnapshot(snapshot => {
                    userPrayerLists = [];
                    const container = document.getElementById('prayer-lists-container');
                    const prayerListSelect = document.getElementById('prayer-list-select');
                    
                    container.innerHTML = '';
                    prayerListSelect.innerHTML = '<option value="">None - Community Prayer Only</option>';
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No prayer lists yet. Create your first list!</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const list = { id: doc.id, ...doc.data() };
                        userPrayerLists.push(list);
                        
                        // Add to prayer lists container
                        const listCard = createPrayerListCard(list);
                        container.appendChild(listCard);
                        
                        // Add to prayer submission dropdown
                        const option = document.createElement('option');
                        option.value = list.id;
                        option.textContent = `📋 ${list.name} (${list.prayerCount || 0} prayers)`;
                        prayerListSelect.appendChild(option);
                    });
                }, error => {
                    console.error('Error loading prayer lists:', error);
                    showError('Failed to load prayer lists');
                });
        }

        // Create prayer list card UI
        function createPrayerListCard(list) {
            const card = document.createElement('div');
            card.className = 'prayer-list-card';
            card.style.cssText = `
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                background: linear-gradient(135deg, ${list.color}15, rgba(255,255,255,0.02));
                border-left: 4px solid ${list.color};
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            `;
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="list-icon" style="
                            width: 40px; 
                            height: 40px; 
                            border-radius: 10px; 
                            background: ${list.color}; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            color: white;
                            font-size: 16px;
                        ">
                            <i class="${list.icon}"></i>
                        </div>
                        <div>
                            <div class="list-name" style="font-weight: 600; color: #fff; font-size: 16px;">${list.name}</div>
                            <div class="list-description" style="color: #999; font-size: 14px; margin-top: 2px;">${list.description || ''}</div>
                            <div class="list-stats" style="color: #ccc; font-size: 12px; margin-top: 4px;">
                                ${list.prayerCount || 0} prayers
                            </div>
                        </div>
                    </div>
                    <div class="list-actions" style="display: flex; gap: 8px;">
                        <button class="edit-list-btn" data-list-id="${list.id}" style="
                            background: rgba(255,255,255,0.1); 
                            border: none; 
                            color: #fff; 
                            padding: 8px; 
                            border-radius: 6px; 
                            cursor: pointer;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        " title="Edit List">
                            <i class="fas fa-edit" style="font-size: 12px;"></i>
                        </button>
                        <button class="view-list-btn" data-list-id="${list.id}" style="
                            background: ${list.color}; 
                            border: none; 
                            color: white; 
                            padding: 8px 12px; 
                            border-radius: 6px; 
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 500;
                        " title="View Prayers">
                            View Prayers
                        </button>
                    </div>
                </div>
            `;
            
            // Add hover effect
            card.addEventListener('mouseenter', () => {
                card.style.background = `linear-gradient(135deg, ${list.color}25, rgba(255,255,255,0.05))`;
                card.style.transform = 'translateY(-2px)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.background = `linear-gradient(135deg, ${list.color}15, rgba(255,255,255,0.02))`;
                card.style.transform = 'translateY(0)';
            });
            
            // Wire up buttons
            card.querySelector('.edit-list-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                editPrayerList(list.id);
            });
            
            card.querySelector('.view-list-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                viewListPrayers(list.id, list.name);
            });
            
            return card;
        }

        // Show prayer list modal
        function showPrayerListModal(listId = null) {
            const modal = document.getElementById('prayer-list-modal');
            const title = document.getElementById('prayer-list-modal-title');
            const form = document.getElementById('prayer-list-form');
            const deleteBtn = document.getElementById('delete-list-btn');
            const saveBtn = document.getElementById('save-list-btn');
            
            currentEditingListId = listId;
            
            if (listId) {
                // Edit mode
                const list = userPrayerLists.find(l => l.id === listId);
                if (!list) return;
                
                title.textContent = 'Edit Prayer List';
                document.getElementById('list-name').value = list.name;
                document.getElementById('list-description').value = list.description || '';
                document.getElementById('list-color').value = list.color;
                document.getElementById('list-icon').value = list.icon;
                
                // Update UI selections
                updateColorSelection(list.color);
                updateIconSelection(list.icon);
                
                deleteBtn.style.display = list.isDefault ? 'none' : 'block';
                saveBtn.textContent = 'Update List';
            } else {
                // Create mode
                title.textContent = 'Create New Prayer List';
                form.reset();
                document.getElementById('list-color').value = '#4CAF50';
                document.getElementById('list-icon').value = 'fas fa-heart';
                updateColorSelection('#4CAF50');
                updateIconSelection('fas fa-heart');
                deleteBtn.style.display = 'none';
                saveBtn.textContent = 'Create List';
            }
            
            modal.style.display = 'flex';
        }

        // Update color selection UI
        function updateColorSelection(selectedColor) {
            document.querySelectorAll('.color-option').forEach(option => {
                if (option.dataset.color === selectedColor) {
                    option.style.borderColor = '#fff';
                    option.style.boxShadow = '0 0 0 2px rgba(255,255,255,0.3)';
                } else {
                    option.style.borderColor = 'transparent';
                    option.style.boxShadow = 'none';
                }
            });
        }

        // Update icon selection UI
        function updateIconSelection(selectedIcon) {
            document.querySelectorAll('.icon-option').forEach(option => {
                if (option.dataset.icon === selectedIcon) {
                    option.style.borderColor = '#fff';
                    option.style.boxShadow = '0 0 0 2px rgba(255,255,255,0.3)';
                } else {
                    option.style.borderColor = 'transparent';
                    option.style.boxShadow = 'none';
                }
            });
        }

        // Save prayer list
        async function savePrayerList(formData) {
            if (!currentUser || !db) return;
            
            try {
                const listData = {
                    userId: currentUser.uid,
                    name: formData.name.trim(),
                    description: formData.description.trim(),
                    color: formData.color,
                    icon: formData.icon,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (currentEditingListId) {
                    // Update existing list
                    await db.collection('prayerLists').doc(currentEditingListId).update(listData);
                    showSuccess('Prayer list updated successfully!');
                } else {
                    // Create new list
                    listData.orderIndex = userPrayerLists.length;
                    listData.isDefault = false;
                    listData.prayerCount = 0;
                    listData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('prayerLists').add(listData);
                    showSuccess('Prayer list created successfully!');
                }
                
                document.getElementById('prayer-list-modal').style.display = 'none';
            } catch (error) {
                console.error('Error saving prayer list:', error);
                showError('Failed to save prayer list. Please try again.');
            }
        }

        // Delete prayer list
        async function deletePrayerList(listId) {
            if (!listId || !db) return;
            
            const list = userPrayerLists.find(l => l.id === listId);
            if (!list || list.isDefault) {
                showError('Cannot delete default prayer list');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${list.name}"? This will remove all prayers from this list but won't delete the prayers themselves.`)) {
                return;
            }
            
            try {
                // Delete all prayer list items for this list
                const listItems = await db.collection('prayerListItems')
                    .where('prayerListId', '==', listId)
                    .get();
                
                const batch = db.batch();
                listItems.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // Delete the list itself
                batch.delete(db.collection('prayerLists').doc(listId));
                
                await batch.commit();
                showSuccess('Prayer list deleted successfully');
                document.getElementById('prayer-list-modal').style.display = 'none';
                
            } catch (error) {
                console.error('Error deleting prayer list:', error);
                showError('Failed to delete prayer list');
            }
        }

        // Edit prayer list
        function editPrayerList(listId) {
            showPrayerListModal(listId);
        }

        // View prayers in a specific list
        function viewListPrayers(listId, listName) {
            if (!listId || !db) return;
            
            const listPrayersCard = document.getElementById('list-prayers-card');
            const listPrayersTitle = document.getElementById('list-prayers-title');
            const listPrayersContainer = document.getElementById('list-prayers-container');
            
            listPrayersTitle.textContent = `${listName} Prayers`;
            listPrayersCard.style.display = 'block';
            listPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading prayers...</div>';
            
            // Load prayers for this list
            db.collection('prayerListItems')
                .where('prayerListId', '==', listId)
                .orderBy('orderIndex', 'asc')
                .onSnapshot(async snapshot => {
                    if (snapshot.empty) {
                        listPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No prayers in this list yet.</div>';
                        return;
                    }
                    
                    listPrayersContainer.innerHTML = '';
                    
                    // Get prayer details for each item
                    for (const doc of snapshot.docs) {
                        const item = doc.data();
                        try {
                            const prayerDoc = await db.collection('prayers').doc(item.prayerId).get();
                            if (prayerDoc.exists) {
                                const prayer = { id: prayerDoc.id, ...prayerDoc.data() };
                                const prayerCard = createListPrayerCard(prayer, item, listId);
                                listPrayersContainer.appendChild(prayerCard);
                            }
                        } catch (error) {
                            console.error('Error loading prayer details:', error);
                        }
                    }
                }, error => {
                    console.error('Error loading list prayers:', error);
                    listPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading prayers.</div>';
                });
        }

        // Create prayer card for list view
        function createListPrayerCard(prayer, listItem, listId) {
            const card = document.createElement('div');
            card.className = 'prayer-request card';
            card.style.marginBottom = '12px';
            
            card.innerHTML = `
                <div class="prayer-user">
                    <div class="avatar">${(prayer.userDisplayName || 'U').substring(0,2)}</div>
                    <div class="user-info">
                        <div class="user-name">${prayer.userDisplayName || 'User'}</div>
                        <div class="request-time">${prayer.createdAt ? new Date(prayer.createdAt.toDate()).toLocaleDateString() : 'Recently'}</div>
                    </div>
                    <div class="urgency-tag ${prayer.urgency ? `urgency-${prayer.urgency}` : ''}">${prayer.urgency || 'General'}</div>
                </div>
                <div class="prayer-content">
                    <div class="prayer-title">${prayer.title || 'Prayer Request'}</div>
                    <div class="prayer-description">${prayer.description || ''}</div>
                </div>
                <div class="prayer-meta">
                    <div class="category-tag">${prayer.category || 'General'}</div>
                    ${prayer.status === 'answered' ? '<div style="color: var(--success); font-weight: 600;">✓ Answered</div>' : ''}
                </div>
                <div class="prayer-actions">
                    <button class="action-btn remove-from-list-btn" data-prayer-id="${prayer.id}" data-list-id="${listId}">
                        <i class="fas fa-times"></i> Remove from List
                    </button>
                    ${prayer.userId === currentUser?.uid ? `
                        <button class="action-btn toggle-status" data-prayer-id="${prayer.id}" data-status="${prayer.status}">
                            ${prayer.status === 'answered' ? '<i class="fas fa-undo"></i> Mark Ongoing' : '<i class="fas fa-check-circle"></i> Mark Answered'}
                        </button>
                    ` : ''}
                </div>
            `;
            
            // Wire up remove button
            card.querySelector('.remove-from-list-btn').addEventListener('click', async () => {
                try {
                    const itemDoc = await db.collection('prayerListItems')
                        .where('prayerListId', '==', listId)
                        .where('prayerId', '==', prayer.id)
                        .get();
                    
                    if (!itemDoc.empty) {
                        await itemDoc.docs[0].ref.delete();
                        // Update prayer count
                        await updatePrayerListCount(listId);
                        showSuccess('Prayer removed from list');
                    }
                } catch (error) {
                    console.error('Error removing prayer from list:', error);
                    showError('Failed to remove prayer from list');
                }
            });
            
            // Wire up status toggle if it's user's prayer
            const statusBtn = card.querySelector('.toggle-status');
            if (statusBtn) {
                statusBtn.addEventListener('click', async () => {
                    const newStatus = statusBtn.dataset.status === 'answered' ? 'ongoing' : 'answered';
                    try {
                        await db.collection('prayers').doc(prayer.id).update({
                            status: newStatus,
                            answeredAt: newStatus === 'answered' ? firebase.firestore.FieldValue.serverTimestamp() : null,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showSuccess(`Prayer marked as ${newStatus}`);
                    } catch (error) {
                        console.error('Error updating prayer status:', error);
                        showError('Failed to update prayer status');
                    }
                });
            }
            
            return card;
        }

        // Update prayer list count
        async function updatePrayerListCount(listId) {
            try {
                const items = await db.collection('prayerListItems')
                    .where('prayerListId', '==', listId)
                    .get();
                
                await db.collection('prayerLists').doc(listId).update({
                    prayerCount: items.size
                });
            } catch (error) {
                console.error('Error updating prayer list count:', error);
            }
        }

        // Add prayer to list
        async function addPrayerToList(prayerId, listId) {
            if (!prayerId || !listId || !currentUser) return;
            
            try {
                // Check if prayer is already in this list
                const existing = await db.collection('prayerListItems')
                    .where('prayerListId', '==', listId)
                    .where('prayerId', '==', prayerId)
                    .get();
                
                if (!existing.empty) {
                    showError('Prayer is already in this list');
                    return;
                }
                
                // Get current max order index for this list
                const listItems = await db.collection('prayerListItems')
                    .where('prayerListId', '==', listId)
                    .orderBy('orderIndex', 'desc')
                    .limit(1)
                    .get();
                
                const maxOrderIndex = listItems.empty ? 0 : listItems.docs[0].data().orderIndex + 1;
                
                // Add prayer to list
                await db.collection('prayerListItems').add({
                    prayerListId: listId,
                    prayerId: prayerId,
                    orderIndex: maxOrderIndex,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: currentUser.uid
                });
                
                // Update prayer list count
                await updatePrayerListCount(listId);
                
                return true;
            } catch (error) {
                console.error('Error adding prayer to list:', error);
                showError('Failed to add prayer to list');
                return false;
            }
        }

        // Initialize prayer list UI handlers
        function initPrayerListHandlers() {
            // Add list button
            document.getElementById('add-list-btn')?.addEventListener('click', () => {
                showPrayerListModal();
            });
            
            // Close modal
            document.getElementById('prayer-list-close')?.addEventListener('click', () => {
                document.getElementById('prayer-list-modal').style.display = 'none';
            });
            
            // Color picker
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    const color = option.dataset.color;
                    document.getElementById('list-color').value = color;
                    updateColorSelection(color);
                });
            });
            
            // Icon picker
            document.querySelectorAll('.icon-option').forEach(option => {
                option.addEventListener('click', () => {
                    const icon = option.dataset.icon;
                    document.getElementById('list-icon').value = icon;
                    updateIconSelection(icon);
                });
            });
            
            // Form submission
            document.getElementById('prayer-list-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('list-name').value,
                    description: document.getElementById('list-description').value,
                    color: document.getElementById('list-color').value,
                    icon: document.getElementById('list-icon').value
                };
                
                if (!formData.name.trim()) {
                    showError('Please enter a list name');
                    return;
                }
                
                await savePrayerList(formData);
            });
            
            // Delete button
            document.getElementById('delete-list-btn')?.addEventListener('click', async () => {
                if (currentEditingListId) {
                    await deletePrayerList(currentEditingListId);
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('prayer-list-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'prayer-list-modal') {
                    document.getElementById('prayer-list-modal').style.display = 'none';
                }
            });
        }

        // ===== PRAYER REMINDERS FUNCTIONALITY =====
        
        let currentEditingReminderId = null;
        let userReminders = [];
        let activeReminderTimeouts = new Map(); // Track active reminder schedules

        // Initialize default prayer reminder for new users
        async function initializeDefaultReminder(uid) {
            if (!uid || !db) return;
            
            try {
                // Check if user already has reminders
                const existingReminders = await db.collection('prayerReminders')
                    .where('userId', '==', uid)
                    .get();
                
                if (!existingReminders.empty) return; // User already has reminders
                
                // Create a default morning reminder
                const defaultReminder = {
                    userId: uid,
                    title: 'Morning Prayer',
                    description: 'Start your day with prayer and reflection',
                    time: '09:00',
                    frequency: 'daily',
                    daysOfWeek: [1, 2, 3, 4, 5, 6, 0], // All days
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    prayerListId: '',
                    reminderType: 'general',
                    isActive: true,
                    notificationMethod: ['browser'],
                    soundEnabled: true,
                    snoozeEnabled: true,
                    snoozeDuration: 10,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastTriggered: null,
                    nextScheduled: null,
                    triggerCount: 0
                };
                
                await db.collection('prayerReminders').add(defaultReminder);
                console.log('✅ Default prayer reminder created for user');
                
            } catch (error) {
                console.error('Error creating default reminder:', error);
            }
        }

        // Load user's prayer reminders
        function loadPrayerReminders(uid) {
            if (!uid || !db) return;
            
            db.collection('prayerReminders')
                .where('userId', '==', uid)
                .orderBy('time', 'asc')
                .onSnapshot(snapshot => {
                    userReminders = [];
                    const container = document.getElementById('reminders-list');
                    const reminderPrayerListSelect = document.getElementById('reminder-prayer-list');
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No prayer reminders yet. Create your first reminder!</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const reminder = { id: doc.id, ...doc.data() };
                        userReminders.push(reminder);
                        
                        // Add to reminders list
                        const reminderCard = createReminderCard(reminder);
                        container.appendChild(reminderCard);
                        
                        // Schedule the reminder if active
                        if (reminder.isActive) {
                            scheduleReminder(reminder);
                        }
                    });
                    
                    // Update reminder dropdown in reminder form with prayer lists
                    if (reminderPrayerListSelect && userPrayerLists) {
                        reminderPrayerListSelect.innerHTML = '<option value="">General Reminder</option>';
                        userPrayerLists.forEach(list => {
                            const option = document.createElement('option');
                            option.value = list.id;
                            option.textContent = `📋 ${list.name}`;
                            reminderPrayerListSelect.appendChild(option);
                        });
                    }
                }, error => {
                    console.error('Error loading prayer reminders:', error);
                    showError('Failed to load prayer reminders');
                });
        }

        // Create reminder card UI
        function createReminderCard(reminder) {
            const card = document.createElement('div');
            card.className = 'reminder-card';
            card.style.cssText = `
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                background: ${reminder.isActive ? 'rgba(76, 175, 80, 0.1)' : 'rgba(158, 158, 158, 0.1)'};
                border-left: 4px solid ${reminder.isActive ? '#4CAF50' : '#9E9E9E'};
                transition: all 0.2s ease;
            `;
            
            const frequencyText = getFrequencyDisplayText(reminder.frequency, reminder.daysOfWeek);
            const timeDisplay = formatTime(reminder.time);
            const prayerListName = reminder.prayerListId ? 
                (userPrayerLists.find(l => l.id === reminder.prayerListId)?.name || 'Unknown List') : 
                'General';
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div class="reminder-icon" style="
                                width: 36px; 
                                height: 36px; 
                                border-radius: 50%; 
                                background: ${reminder.isActive ? '#4CAF50' : '#9E9E9E'}; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                color: white;
                                font-size: 14px;
                            ">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div>
                                <div class="reminder-title" style="font-weight: 600; color: #fff; font-size: 16px;">${reminder.title}</div>
                                <div class="reminder-time" style="color: #4CAF50; font-weight: 500; font-size: 14px;">${timeDisplay} - ${frequencyText}</div>
                            </div>
                        </div>
                        
                        ${reminder.description ? `
                            <div class="reminder-description" style="color: #ccc; font-size: 14px; margin-bottom: 8px;">${reminder.description}</div>
                        ` : ''}
                        
                        <div class="reminder-meta" style="display: flex; gap: 12px; align-items: center;">
                            <span style="font-size: 12px; color: #999; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">
                                📋 ${prayerListName}
                            </span>
                            <span style="font-size: 12px; color: #999;">
                                <i class="fas fa-volume-${reminder.soundEnabled ? 'up' : 'mute'}"></i>
                                ${reminder.soundEnabled ? 'Sound On' : 'Silent'}
                            </span>
                            ${reminder.snoozeEnabled ? `
                                <span style="font-size: 12px; color: #999;">
                                    <i class="fas fa-clock"></i> Snooze ${reminder.snoozeDuration}min
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="reminder-actions" style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                        <label class="switch" style="margin: 0;">
                            <input type="checkbox" class="reminder-toggle" data-reminder-id="${reminder.id}" ${reminder.isActive ? 'checked' : ''}>
                            <span>${reminder.isActive ? 'Active' : 'Inactive'}</span>
                        </label>
                        <div style="display: flex; gap: 8px;">
                            <button class="edit-reminder-btn" data-reminder-id="${reminder.id}" style="
                                background: rgba(255,255,255,0.1); 
                                border: none; 
                                color: #fff; 
                                padding: 6px 8px; 
                                border-radius: 4px; 
                                cursor: pointer;
                                font-size: 12px;
                            " title="Edit Reminder">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Wire up toggle
            const toggle = card.querySelector('.reminder-toggle');
            toggle.addEventListener('change', async () => {
                try {
                    const isActive = toggle.checked;
                    await db.collection('prayerReminders').doc(reminder.id).update({
                        isActive: isActive,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    if (isActive) {
                        scheduleReminder({...reminder, isActive: true});
                        showSuccess('Reminder activated');
                    } else {
                        cancelReminderSchedule(reminder.id);
                        showSuccess('Reminder deactivated');
                    }
                } catch (error) {
                    console.error('Error toggling reminder:', error);
                    showError('Failed to update reminder');
                    toggle.checked = !toggle.checked; // Revert toggle
                }
            });
            
            // Wire up edit button
            card.querySelector('.edit-reminder-btn').addEventListener('click', () => {
                editReminder(reminder.id);
            });
            
            return card;
        }

        // Helper function to format time display
        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            const hour12 = parseInt(hours) % 12 || 12;
            const ampm = parseInt(hours) >= 12 ? 'PM' : 'AM';
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Helper function to get frequency display text
        function getFrequencyDisplayText(frequency, daysOfWeek) {
            switch (frequency) {
                case 'daily': return 'Daily';
                case 'weekdays': return 'Weekdays';
                case 'weekends': return 'Weekends';
                case 'weekly': return 'Weekly';
                case 'custom': 
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const selectedDays = daysOfWeek.map(d => dayNames[d]).join(', ');
                    return selectedDays;
                default: return 'Custom';
            }
        }

        // Schedule reminder notifications
        function scheduleReminder(reminder) {
            if (!reminder.isActive) return;
            
            // Cancel existing schedule if any
            cancelReminderSchedule(reminder.id);
            
            const now = new Date();
            const nextTrigger = calculateNextTriggerTime(reminder, now);
            
            if (!nextTrigger) return;
            
            const timeUntilTrigger = nextTrigger.getTime() - now.getTime();
            
            if (timeUntilTrigger > 0) {
                const timeoutId = setTimeout(() => {
                    triggerReminder(reminder);
                    // Schedule the next occurrence
                    scheduleReminder(reminder);
                }, timeUntilTrigger);
                
                activeReminderTimeouts.set(reminder.id, timeoutId);
                console.log(`📅 Reminder "${reminder.title}" scheduled for ${nextTrigger.toLocaleString()}`);
            }
        }

        // Calculate next trigger time for a reminder
        function calculateNextTriggerTime(reminder, fromTime) {
            const [hours, minutes] = reminder.time.split(':').map(Number);
            const next = new Date(fromTime);
            
            // Set to today at the reminder time
            next.setHours(hours, minutes, 0, 0);
            
            // If time has passed today, move to next valid day
            if (next <= fromTime) {
                next.setDate(next.getDate() + 1);
            }
            
            // Find next valid day based on frequency
            let attempts = 0;
            while (attempts < 8) { // Prevent infinite loop
                const dayOfWeek = next.getDay();
                
                if (isValidDay(reminder.frequency, reminder.daysOfWeek, dayOfWeek)) {
                    return next;
                }
                
                next.setDate(next.getDate() + 1);
                attempts++;
            }
            
            return null; // No valid day found
        }

        // Check if a day is valid for the reminder frequency
        function isValidDay(frequency, daysOfWeek, dayOfWeek) {
            switch (frequency) {
                case 'daily': return true;
                case 'weekdays': return dayOfWeek >= 1 && dayOfWeek <= 5;
                case 'weekends': return dayOfWeek === 0 || dayOfWeek === 6;
                case 'weekly': return daysOfWeek.includes(dayOfWeek);
                case 'custom': return daysOfWeek.includes(dayOfWeek);
                default: return false;
            }
        }

        // Cancel reminder schedule
        function cancelReminderSchedule(reminderId) {
            const timeoutId = activeReminderTimeouts.get(reminderId);
            if (timeoutId) {
                clearTimeout(timeoutId);
                activeReminderTimeouts.delete(reminderId);
            }
        }

        // Trigger reminder notification
        async function triggerReminder(reminder) {
            console.log(`🔔 Triggering reminder: ${reminder.title}`);
            
            try {
                // Update last triggered time
                await db.collection('prayerReminders').doc(reminder.id).update({
                    lastTriggered: firebase.firestore.FieldValue.serverTimestamp(),
                    triggerCount: firebase.firestore.FieldValue.increment(1)
                });
                
                // Show browser notification
                if (reminder.notificationMethod.includes('browser')) {
                    showReminderNotification(reminder);
                }
                
                // Create reminder instance for tracking
                await db.collection('reminderInstances').add({
                    reminderId: reminder.id,
                    userId: reminder.userId,
                    scheduledTime: firebase.firestore.FieldValue.serverTimestamp(),
                    actualTriggerTime: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'triggered',
                    title: reminder.title,
                    message: reminder.description || 'Time for prayer and reflection',
                    userAction: null,
                    actionTimestamp: null,
                    snoozeUntil: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Error triggering reminder:', error);
            }
        }

        // Show browser notification
        function showReminderNotification(reminder) {
            const title = reminder.title;
            const message = reminder.description || 'Time for prayer and reflection';
            const prayerListName = reminder.prayerListId ? 
                (userPrayerLists.find(l => l.id === reminder.prayerListId)?.name || '') : '';
            
            const fullMessage = prayerListName ? 
                `${message}\n📋 ${prayerListName}` : message;
            
            // Request permission if needed
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        createNotification(title, fullMessage, reminder);
                    }
                });
            } else if (Notification.permission === 'granted') {
                createNotification(title, fullMessage, reminder);
            }
            
            // Also show in-app notification
            showInAppReminder(reminder);
        }

        // Create browser notification
        function createNotification(title, message, reminder) {
            const notification = new Notification(title, {
                body: message,
                icon: 'Fear God.png', // Your app icon
                badge: 'Fear God.png',
                tag: `prayer-reminder-${reminder.id}`,
                requireInteraction: true,
                actions: [
                    { action: 'pray', title: '🙏 Start Praying' },
                    { action: 'snooze', title: '⏰ Snooze 10min' }
                ]
            });
            
            notification.onclick = () => {
                window.focus();
                // Navigate to appropriate section
                if (reminder.prayerListId) {
                    document.querySelector('[data-tab="prayerListsTab"]').click();
                    viewListPrayers(reminder.prayerListId, 
                        userPrayerLists.find(l => l.id === reminder.prayerListId)?.name || 'Prayer List'
                    );
                } else {
                    document.querySelector('[data-tab="submitTab"]').click();
                }
                notification.close();
            };
            
            // Auto-close after 30 seconds
            setTimeout(() => notification.close(), 30000);
        }

        // Show in-app reminder
        function showInAppReminder(reminder) {
            const reminderToast = document.createElement('div');
            reminderToast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 10001;
                max-width: 350px;
                border: 1px solid rgba(255,255,255,0.2);
                backdrop-filter: blur(10px);
            `;
            
            const prayerListName = reminder.prayerListId ? 
                (userPrayerLists.find(l => l.id === reminder.prayerListId)?.name || '') : '';
            
            reminderToast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">🔔</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${reminder.title}</div>
                        <div style="font-size: 14px; opacity: 0.9;">${reminder.description || 'Time for prayer and reflection'}</div>
                        ${prayerListName ? `<div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">📋 ${prayerListName}</div>` : ''}
                    </div>
                    <button style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.7;" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="reminder-action-btn" data-action="pray" style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        🙏 Start Praying
                    </button>
                    ${reminder.snoozeEnabled ? `
                        <button class="reminder-action-btn" data-action="snooze" style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ⏰ Snooze ${reminder.snoozeDuration}min
                        </button>
                    ` : ''}
                </div>
            `;
            
            // Wire up action buttons
            reminderToast.querySelectorAll('.reminder-action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    handleReminderAction(reminder, action);
                    reminderToast.remove();
                });
            });
            
            document.body.appendChild(reminderToast);
            
            // Auto-remove after 60 seconds
            setTimeout(() => {
                if (reminderToast.parentElement) {
                    reminderToast.remove();
                }
            }, 60000);
            
            // Play sound if enabled
            if (reminder.soundEnabled) {
                playNotificationSound();
            }
        }

        // Handle reminder actions
        function handleReminderAction(reminder, action) {
            switch (action) {
                case 'pray':
                    // Navigate to prayer section
                    if (reminder.prayerListId) {
                        document.querySelector('[data-tab="prayerListsTab"]').click();
                        viewListPrayers(reminder.prayerListId, 
                            userPrayerLists.find(l => l.id === reminder.prayerListId)?.name || 'Prayer List'
                        );
                    } else {
                        document.querySelector('[data-tab="submitTab"]').click();
                    }
                    break;
                    
                case 'snooze':
                    // Schedule snooze
                    if (reminder.snoozeEnabled) {
                        const snoozeTime = new Date();
                        snoozeTime.setMinutes(snoozeTime.getMinutes() + reminder.snoozeDuration);
                        
                        setTimeout(() => {
                            showReminderNotification(reminder);
                        }, reminder.snoozeDuration * 60 * 1000);
                        
                        showSuccess(`Snoozed for ${reminder.snoozeDuration} minutes`);
                    }
                    break;
            }
        }

        // Play notification sound
        function playNotificationSound() {
            // Create audio context for notification sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Could not play notification sound:', error);
            }
        }

        // Show reminder modal
        function showReminderModal(reminderId = null) {
            const modal = document.getElementById('reminder-modal');
            const title = document.getElementById('reminder-modal-title');
            const form = document.getElementById('reminder-form');
            const deleteBtn = document.getElementById('delete-reminder-btn');
            const saveBtn = document.getElementById('save-reminder-btn');
            
            currentEditingReminderId = reminderId;
            
            if (reminderId) {
                // Edit mode
                const reminder = userReminders.find(r => r.id === reminderId);
                if (!reminder) return;
                
                title.textContent = 'Edit Prayer Reminder';
                document.getElementById('reminder-title').value = reminder.title;
                document.getElementById('reminder-description').value = reminder.description || '';
                document.getElementById('reminder-time').value = reminder.time;
                document.getElementById('reminder-frequency').value = reminder.frequency;
                document.getElementById('reminder-prayer-list').value = reminder.prayerListId || '';
                document.getElementById('reminder-sound').checked = reminder.soundEnabled;
                document.getElementById('reminder-snooze').checked = reminder.snoozeEnabled;
                
                // Handle custom days
                if (reminder.frequency === 'custom') {
                    document.getElementById('custom-days-row').style.display = 'block';
                    // Set selected days
                    document.querySelectorAll('.day-checkbox input').forEach(checkbox => {
                        checkbox.checked = reminder.daysOfWeek.includes(parseInt(checkbox.value));
                    });
                }
                
                deleteBtn.style.display = 'block';
                saveBtn.textContent = 'Update Reminder';
            } else {
                // Create mode
                title.textContent = 'Create Prayer Reminder';
                form.reset();
                document.getElementById('reminder-sound').checked = true;
                document.getElementById('reminder-snooze').checked = true;
                document.getElementById('custom-days-row').style.display = 'none';
                deleteBtn.style.display = 'none';
                saveBtn.textContent = 'Create Reminder';
            }
            
            modal.style.display = 'flex';
        }

        // Save reminder
        async function saveReminder(formData) {
            if (!currentUser || !db) return;
            
            try {
                // Convert days for frequency
                let daysOfWeek = [];
                switch (formData.frequency) {
                    case 'daily':
                        daysOfWeek = [0, 1, 2, 3, 4, 5, 6];
                        break;
                    case 'weekdays':
                        daysOfWeek = [1, 2, 3, 4, 5];
                        break;
                    case 'weekends':
                        daysOfWeek = [0, 6];
                        break;
                    case 'weekly':
                        daysOfWeek = [new Date().getDay()]; // Same day each week
                        break;
                    case 'custom':
                        daysOfWeek = Array.from(document.querySelectorAll('.day-checkbox input:checked'))
                            .map(cb => parseInt(cb.value));
                        break;
                }
                
                if (daysOfWeek.length === 0 && formData.frequency === 'custom') {
                    showError('Please select at least one day for custom frequency');
                    return;
                }
                
                const reminderData = {
                    userId: currentUser.uid,
                    title: formData.title.trim(),
                    description: formData.description.trim(),
                    time: formData.time,
                    frequency: formData.frequency,
                    daysOfWeek: daysOfWeek,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    prayerListId: formData.prayerListId || '',
                    reminderType: formData.prayerListId ? 'prayer_list' : 'general',
                    isActive: true,
                    notificationMethod: ['browser'],
                    soundEnabled: formData.soundEnabled,
                    snoozeEnabled: formData.snoozeEnabled,
                    snoozeDuration: 10,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (currentEditingReminderId) {
                    // Update existing reminder
                    await db.collection('prayerReminders').doc(currentEditingReminderId).update(reminderData);
                    showSuccess('Prayer reminder updated successfully!');
                } else {
                    // Create new reminder
                    reminderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    reminderData.lastTriggered = null;
                    reminderData.nextScheduled = null;
                    reminderData.triggerCount = 0;
                    
                    await db.collection('prayerReminders').add(reminderData);
                    showSuccess('Prayer reminder created successfully!');
                }
                
                document.getElementById('reminder-modal').style.display = 'none';
            } catch (error) {
                console.error('Error saving reminder:', error);
                showError('Failed to save reminder. Please try again.');
            }
        }

        // Delete reminder
        async function deleteReminder(reminderId) {
            if (!reminderId || !db) return;
            
            const reminder = userReminders.find(r => r.id === reminderId);
            if (!reminder) return;
            
            if (!confirm(`Are you sure you want to delete the reminder "${reminder.title}"?`)) {
                return;
            }
            
            try {
                // Cancel any active schedule
                cancelReminderSchedule(reminderId);
                
                // Delete reminder instances
                const instances = await db.collection('reminderInstances')
                    .where('reminderId', '==', reminderId)
                    .get();
                
                const batch = db.batch();
                instances.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // Delete the reminder itself
                batch.delete(db.collection('prayerReminders').doc(reminderId));
                
                await batch.commit();
                showSuccess('Prayer reminder deleted successfully');
                document.getElementById('reminder-modal').style.display = 'none';
                
            } catch (error) {
                console.error('Error deleting reminder:', error);
                showError('Failed to delete reminder');
            }
        }

        // Edit reminder
        function editReminder(reminderId) {
            showReminderModal(reminderId);
        }

        // Create quick reminder
        async function createQuickReminder(time, title) {
            if (!currentUser) return;
            
            try {
                const reminderData = {
                    userId: currentUser.uid,
                    title: title,
                    description: 'A moment for prayer and reflection',
                    time: time,
                    frequency: 'daily',
                    daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    prayerListId: '',
                    reminderType: 'general',
                    isActive: true,
                    notificationMethod: ['browser'],
                    soundEnabled: true,
                    snoozeEnabled: true,
                    snoozeDuration: 10,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastTriggered: null,
                    nextScheduled: null,
                    triggerCount: 0
                };
                
                await db.collection('prayerReminders').add(reminderData);
                showSuccess(`${title} reminder created!`);
                
            } catch (error) {
                console.error('Error creating quick reminder:', error);
                showError('Failed to create reminder');
            }
        }

        // Initialize reminder UI handlers
        function initReminderHandlers() {
            // Settings tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.settingsTab;
                    
                    // Update tab appearance
                    document.querySelectorAll('.settings-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.color = '#999';
                        t.style.borderBottomColor = 'transparent';
                    });
                    tab.classList.add('active');
                    tab.style.color = '#fff';
                    tab.style.borderBottomColor = '#4CAF50';
                    
                    // Show/hide tab content
                    document.querySelectorAll('.settings-tab-content').forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    document.getElementById(`${tabName}-settings`).classList.add('active');
                    document.getElementById(`${tabName}-settings`).style.display = 'block';
                    
                    // Load reminders when switching to reminders tab
                    if (tabName === 'reminders' && currentUser) {
                        loadPrayerReminders(currentUser.uid);
                    }
                });
            });
            
            // Add reminder button
            document.getElementById('add-reminder-btn')?.addEventListener('click', () => {
                showReminderModal();
            });
            
            // Quick reminder buttons
            document.querySelectorAll('.quick-reminder-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const time = btn.dataset.time;
                    const title = btn.dataset.title;
                    createQuickReminder(time, title);
                });
            });
            
            // Close reminder modal
            document.getElementById('reminder-close')?.addEventListener('click', () => {
                document.getElementById('reminder-modal').style.display = 'none';
            });
            
            // Frequency change handler
            document.getElementById('reminder-frequency')?.addEventListener('change', (e) => {
                const customDaysRow = document.getElementById('custom-days-row');
                if (e.target.value === 'custom') {
                    customDaysRow.style.display = 'block';
                } else {
                    customDaysRow.style.display = 'none';
                }
            });
            
            // Form submission
            document.getElementById('reminder-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    title: document.getElementById('reminder-title').value,
                    description: document.getElementById('reminder-description').value,
                    time: document.getElementById('reminder-time').value,
                    frequency: document.getElementById('reminder-frequency').value,
                    prayerListId: document.getElementById('reminder-prayer-list').value,
                    soundEnabled: document.getElementById('reminder-sound').checked,
                    snoozeEnabled: document.getElementById('reminder-snooze').checked
                };
                
                if (!formData.title.trim()) {
                    showError('Please enter a reminder title');
                    return;
                }
                
                if (!formData.time) {
                    showError('Please select a time');
                    return;
                }
                
                await saveReminder(formData);
            });
            
            // Delete button
            document.getElementById('delete-reminder-btn')?.addEventListener('click', async () => {
                if (currentEditingReminderId) {
                    await deleteReminder(currentEditingReminderId);
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('reminder-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'reminder-modal') {
                    document.getElementById('reminder-modal').style.display = 'none';
                }
            });
        }

        // Request notification permission on first use
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showSuccess('Notifications enabled! You\'ll receive prayer reminders.');
                    } else {
                        showError('Notifications denied. You can enable them in browser settings.');
                    }
                });
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTabNavigation();
            initFormHandling();
            initAuth();
            initPrayerListHandlers();
            initReminderHandlers();
            
            // Show default tab (Feed)
            const defaultTab = document.getElementById('feedTab');
            if (defaultTab) {
                defaultTab.classList.add('active');
                defaultTab.style.display = 'flex';
                defaultTab.style.flexDirection = 'column';
                defaultTab.style.gap = '15px';
            }
            
            // Firebase authentication listener
            if (auth && db) {
                setLoading(true);
                
                auth.onAuthStateChanged(async user => {
                    currentUser = user;
                    const uid = user ? user.uid : null;
                    
                    // Update UI based on auth state
                    updateUIForAuthState(user);
                    
                    if (user) {
                        console.log('User signed in:', user.email);
                        updateUserStats(uid);
                        
                        // Initialize prayer lists for user
                        await initializeDefaultPrayerLists(uid);
                        loadPrayerLists(uid);
                        
                        // Initialize prayer reminders for user
                        await initializeDefaultReminder(uid);
                        loadPrayerReminders(uid);
                        
                        // Request notification permission if needed
                        if (Notification.permission === 'default') {
                            // Delay to avoid overwhelming new users
                            setTimeout(() => {
                                requestNotificationPermission();
                            }, 3000);
                        }
                        
                        // Load notification settings
                        db.collection('users').doc(uid).get().then(doc => {
                            const data = doc.data() || {};
                            document.getElementById('settings-email').value = data.email || user.email || '';
                            document.getElementById('settings-notify-email').checked = !!data.notifyEmail;
                            document.getElementById('settings-weekly-summary').checked = !!data.weeklySummary;
                            document.getElementById('settings-notify-push').checked = !!data.notifyPush;
                        }).catch(e => console.log('Error loading settings:', e));
                        
                        // Wire up settings save button
                        document.getElementById('settings-save').onclick = async () => {
                            const email = document.getElementById('settings-email').value.trim();
                            const notifyEmail = document.getElementById('settings-notify-email').checked;
                            const weeklySummary = document.getElementById('settings-weekly-summary').checked;
                            const notifyPush = document.getElementById('settings-notify-push').checked;
                            
                            if (email && !/\S+@\S+\.\S+/.test(email)) {
                                showError('Please enter a valid email address.');
                                return;
                            }
                            
                            try {
                                await db.collection('users').doc(uid).set({ 
                                    email, 
                                    notifyEmail, 
                                    weeklySummary,
                                    notifyPush,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: true });
                                
                                showSuccess('Settings saved successfully!');
                                document.getElementById('settings-modal').style.display = 'none';
                            } catch (error) {
                                console.error('Settings save error:', error);
                                showError('Failed to save settings. Please try again.');
                            }
                        };
                        
                        // Load notifications
                        const panel = document.getElementById('notif-panel');
                        const badge = document.getElementById('notif-count');
                        const bell = document.getElementById('notif-bell');
                        
                        let notifOpen = false;
                        bell.addEventListener('click', () => {
                            notifOpen = !notifOpen;
                            panel.style.display = notifOpen ? 'block' : 'none';
                        });
                        
                        // Listen for notifications
                        db.collection('notifications')
                            .where('userId', '==', uid)
                            .orderBy('createdAt', 'desc')
                            .limit(20)
                            .onSnapshot(snapshot => {
                                let unreadCount = 0;
                                panel.innerHTML = '';
                                
                                if (snapshot.empty) {
                                    panel.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No notifications yet</div>';
                                } else {
                                    snapshot.forEach(doc => {
                                        const n = doc.data();
                                        if (!n.read) unreadCount++;
                                        
                                        const div = document.createElement('div');
                                        div.className = 'notif-item' + (!n.read ? ' unread' : '');
                                        const timeAgo = n.createdAt ? new Date(n.createdAt.toDate()).toLocaleString() : 'Just now';
                                        
                                        div.innerHTML = `
                                            <div class="notif-text" style="font-weight: 500; margin-bottom: 4px;">${n.message || 'New notification'}</div>
                                            <div class="notif-time" style="font-size: 0.8em; color: #999; margin-bottom: 8px;">${timeAgo}</div>
                                            <div class="notif-actions">
                                                <button class="link-btn mark-read">${n.read ? 'Read' : 'Mark Read'}</button>
                                            </div>`;
                                        
                                        div.querySelector('.mark-read').addEventListener('click', () => {
                                            doc.ref.update({ read: true });
                                        });
                                        
                                        panel.appendChild(div);
                                    });
                                }
                                
                                // Update badge
                                if (unreadCount > 0) {
                                    badge.style.display = 'inline-block';
                                    badge.textContent = String(unreadCount);
                                } else {
                                    badge.style.display = 'none';
                                }
                            });
                    } else {
                        console.log('No user signed in');
                    }
                    
                    // Load prayers feed
                    if (activeUnsub) {
                        activeUnsub();
                        activeUnsub = null;
                    }
                    
                    activeUnsub = db.collection('prayers')
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .onSnapshot(snapshot => {
                            setLoading(false);
                            const docs = snapshot.docs.filter(doc => {
                                const p = doc.data();
                                // Show public and anonymous prayers to everyone
                                // Only show private prayers to their owner
                                if (p.privacy === 'private') {
                                    return uid && p.userId === uid;
                                }
                                return true;
                            });
                            renderPrayers(docs, uid);
                        }, error => {
                            setLoading(false);
                            console.error('Error loading prayers:', error);
                            showError('Failed to load prayers. Please refresh the page.');
                        });
                });
            } else {
                console.error('Firebase not initialized properly');
                showError('Unable to connect to prayer network. Please refresh the page.');
            }
        });
    </script>
</body>
</html>

