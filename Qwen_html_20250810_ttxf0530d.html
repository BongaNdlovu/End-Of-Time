<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Time Prayer Network</title>
    <link rel="stylesheet" href="prayer-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <video id="background-video" src="background.mp4" autoplay loop muted playsinline></video>
    <div class="app-container">
        <!-- Horizontal Nav -->
        <nav class="navbar">
            <div class="nav-brand">
                <img src="Fear God.png" alt="Fear God Imprints Logo" class="logo logo-pulse" style="height:28px;">
                <span class="title">End of Time Prayer Network</span>
            </div>
            <div class="nav-links">
                <a href="#" id="nav-home-link">Home</a>
                <a href="#" id="nav-about-link">My Prayers</a>
                <a href="#" id="nav-wall-link">Prayer Wall</a>
            </div>
            <div class="nav-cta">
                <div style="position:relative;">
                    <button class="notif-btn" id="notif-bell"><i class="fas fa-bell"></i><span class="notif-badge" id="notif-count" style="display:none;">0</span></button>
                    <div class="notif-panel" id="notif-panel"></div>
                </div>
                <button class="cta-btn" id="notif-settings-btn" title="Notification Settings"><i class="fas fa-sliders-h"></i></button>
                <button class="cta-btn" id="nav-submit-btn">Submit Prayer</button>
            </div>
        </nav>

        <!-- Hero -->
        <section class="hero">
            <h1>A <span class="accent">Global Community</span> United in <span class="accent">Prayer</span></h1>
            <p>In these final moments, let us stand together. Share your burdens, lift up others, and find strength in our collective faith.</p>
            <div class="hero-cta">
                <button class="pill-btn" id="hero-view-wall">View the Prayer Wall</button>
            </div>
        </section>

        <!-- Notification Settings Modal -->
        <div class="modal-backdrop" id="settings-modal" style="display:none;">
            <div class="modal-card">
                <div class="modal-header">
                    <div class="modal-title">Notification Settings</div>
                    <button class="close-x" id="settings-close">Close</button>
                </div>
                <div class="form-row">
                    <label for="settings-email">Email</label>
                    <input type="email" id="settings-email" placeholder="you@example.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;">
                </div>
                <div class="form-row">
                    <label>Enable Email Alerts</label>
                    <label class="switch"><input type="checkbox" id="settings-notify-email"> <span>Notify by email</span></label>
                </div>
                <div class="form-row">
                    <label>Enable Push Alerts</label>
                    <label class="switch"><input type="checkbox" id="settings-notify-push"> <span>Notify by push</span></label>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
                    <button class="save-btn" id="settings-save">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Prayer Feed Tab -->
            <div class="tab-content active" id="feedTab">
                <!-- Stats Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Your Spiritual Growth</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Prayers Shared</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Prayers Prayed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Answered</div>
                        </div>
                    </div>
                </div>
                
                <!-- Streak Card -->
                <div class="card">
                    <div class="streak-container">
                        <div class="streak-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="streak-info">
                            <div class="streak-title">Current Prayer Streak</div>
                            <div class="streak-count">0 Days</div>
                            <div class="streak-desc">Keep praying to maintain your streak!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Prayer requests will be dynamically added here -->
            </div>
            
            <!-- Submit Prayer Tab -->
            <div class="tab-content" id="submitTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Share Your Prayer Request</div>
                    </div>
                    <form id="prayerForm">
                        <div class="form-group">
                            <label class="form-label">Prayer Title</label>
                            <input type="text" class="form-input" placeholder="Brief description of your request" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prayer Description</label>
                            <textarea class="form-textarea" placeholder="Share more details about your request..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select">
                                <option value="">Select a category</option>
                                <option value="health">Health</option>
                                <option value="family">Family</option>
                                <option value="spiritual">Spiritual Growth</option>
                                <option value="financial">Financial</option>
                                <option value="career">Career</option>
                                <option value="mission">Mission/Outreach</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Urgency Level</label>
                            <select class="form-select">
                                <option value="ongoing">Ongoing</option>
                                <option value="week">This Week</option>
                                <option value="immediate">Immediate</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="anonymous">
                            <label for="anonymous">Submit anonymously</label>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Submit Prayer Request
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboardTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Your Prayer History</div>
                    </div>
                    <div id="user-prayers-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading your prayers...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Answered Prayers</div>
                    </div>
                    <div id="answered-prayers-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading answered prayers...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="feedTab">
                <i class="fas fa-home"></i>
                <div>Feed</div>
            </div>
            <div class="nav-tab" data-tab="submitTab">
                <i class="fas fa-plus-circle"></i>
                <div>Submit</div>
            </div>
            <div class="nav-tab" data-tab="dashboardTab">
                <i class="fas fa-chart-line"></i>
                <div>Dashboard</div>
            </div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA78bvzjP-b7K9TPCbIL3ttzPJr07VR8kY",
            authDomain: "end-of-time-94cd3.firebaseapp.com",
            projectId: "end-of-time-94cd3",
            storageBucket: "end-of-time-94cd3.firebasestorage.app",
            messagingSenderId: "628602476853",
            appId: "1:628602476853:web:181df03c3374465811147c",
            measurementId: "G-E5R3NG1533"
        };

        let auth, db;
        let currentUser = null;
        let activeUnsub = null;
        
        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('✅ Firebase initialized for Prayer Network');
        } catch (e) {
            console.error('❌ Firebase initialization failed:', e);
        }

        // UI Helper Functions
        function setLoading(isLoading) {
            const area = document.getElementById('contentArea');
            if (isLoading) {
                area.setAttribute('aria-busy', 'true');
            } else {
                area.removeAttribute('aria-busy');
            }
        }
        
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            toast.innerHTML = `<i class="fas fa-check" style="margin-right: 8px;"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showError(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            toast.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Render prayers function
        function renderPrayers(snapshotDocs, currentUid) {
            const feed = document.getElementById('feedTab');
            
            // Keep the first two cards (stats and streak)
            const staticCards = feed.querySelectorAll('.card');
            const cardsToKeep = Array.from(staticCards).slice(0, 2);
            
            // Clear everything else
            feed.innerHTML = '';
            cardsToKeep.forEach(card => feed.appendChild(card));

            if (snapshotDocs.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'card';
                emptyState.style.textAlign = 'center';
                emptyState.style.padding = '40px';
                emptyState.innerHTML = `
                    <i class="fas fa-praying-hands" style="font-size: 3rem; color: #999; margin-bottom: 1rem;"></i>
                    <p style="color: #999; font-size: 1.1rem;">No prayers yet. Be the first to share!</p>
                `;
                feed.appendChild(emptyState);
                return;
            }

            snapshotDocs.forEach(doc => {
                const p = doc.data();
                const isOwner = p.userId === currentUid;
                const isAnon = p.isAnonymous === true && !isOwner;
                const displayName = isAnon ? 'Anonymous' : (p.userDisplayName || 'User');

                const wrapper = document.createElement('div');
                wrapper.className = 'prayer-request card' + (isAnon ? ' anonymous' : '');
                wrapper.innerHTML = `
                    <div class="prayer-user">
                        <div class="avatar">${(displayName||'U').substring(0,2)}</div>
                        <div class="user-info">
                            <div class="user-name">${displayName}</div>
                            <div class="request-time">${p.createdAt ? new Date(p.createdAt.toDate()).toLocaleString() : 'Just now'}</div>
                        </div>
                        <div class="urgency-tag ${p.urgency ? `urgency-${p.urgency}`: ''}">${p.urgency || 'General'}</div>
                    </div>
                    <div class="prayer-content">
                        <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                        <div class="prayer-description">${p.description || ''}</div>
                    </div>
                    <div class="prayer-meta">
                        <div class="category-tag">${p.category || 'General'}</div>
                    </div>
                    <div class="prayer-actions">
                        <button class="action-btn pray-btn"><i class="fas fa-pray"></i> I Prayed (<span class="pray-count">0</span>)</button>
                        <button class="action-btn toggle-comments"><i class="fas fa-comment"></i> Comments</button>
                        ${isOwner 
                            ? `<button class="action-btn toggle-status">${p.status === 'answered' ? '<i class="fas fa-undo"></i> Mark Open' : '<i class="fas fa-check-circle"></i> Mark Answered'}</button>`
                            : ''}
                    </div>
                    <div class="comments-container" style="display:none;margin-top:10px;">
                        <div class="comments-list" style="background: rgba(255,255,255,0.05); padding:10px; border-radius:8px; border:1px solid var(--border);"></div>
                        <form class="comment-form" style="display:flex; gap:8px; margin-top:8px;">
                            <input type="text" placeholder="Write a comment..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:#333; color:#fff;">
                            <button class="action-btn" type="submit" style="flex:0 0 auto;">Post</button>
                        </form>
                    </div>`;

                // Wire up the pray button
                const prayBtn = wrapper.querySelector('.pray-btn');
                const prayCount = wrapper.querySelector('.pray-count');
                
                // Update pray count
                db.collection('prayers').doc(doc.id).collection('interactions')
                    .where('type', '==', 'prayed')
                    .onSnapshot(snapshot => {
                        prayCount.textContent = snapshot.size;
                    });

                prayBtn.addEventListener('click', async () => {
                    if (prayBtn.disabled) return;
                    
                    prayBtn.disabled = true;
                    const originalText = prayBtn.innerHTML;
                    prayBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Praying...';

                    try {
                        const userName = currentUser ? (currentUser.displayName || currentUser.email || 'Anonymous') : 'Anonymous';
                        
                        await db.collection('prayers').doc(doc.id).collection('interactions').add({
                            type: 'prayed',
                            userId: currentUid || null,
                            userDisplayName: userName,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        
                        prayBtn.innerHTML = '<i class="fas fa-check"></i> You Prayed (<span class="pray-count">0</span>)';
                        prayBtn.classList.add('answered');
                        
                        showSuccess('Thank you for your prayers!');
                    } catch (e) {
                        console.error('Prayer interaction error:', e);
                        prayBtn.innerHTML = originalText;
                        prayBtn.disabled = false;
                        showError('Unable to record your prayer. Please try again.');
                    }
                });

                // Toggle status button for owners
                const toggleStatus = wrapper.querySelector('.toggle-status');
                if (toggleStatus) {
                    toggleStatus.addEventListener('click', async () => {
                        try {
                            const newStatus = p.status === 'answered' ? 'open' : 'answered';
                            await db.collection('prayers').doc(doc.id).update({ 
                                status: newStatus, 
                                answeredAt: newStatus === 'answered' ? firebase.firestore.FieldValue.serverTimestamp() : null 
                            });
                            showSuccess(`Prayer marked as ${newStatus}`);
                        } catch (e) { 
                            console.error(e); 
                            showError('Failed to update status'); 
                        }
                    });
                }

                // Comments toggle
                const commentsContainer = wrapper.querySelector('.comments-container');
                const toggleComments = wrapper.querySelector('.toggle-comments');
                
                toggleComments.addEventListener('click', () => {
                    const isOpen = commentsContainer.style.display !== 'none';
                    commentsContainer.style.display = isOpen ? 'none' : 'block';
                });

                feed.appendChild(wrapper);
            });
        }

        // Tab Navigation
        function initTabNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    const tabId = tab.getAttribute('data-tab');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                        targetTab.style.display = 'flex';
                        targetTab.style.flexDirection = 'column';
                        targetTab.style.gap = '15px';
                        
                        // Load dashboard data when switching to dashboard tab
                        if (tabId === 'dashboardTab' && currentUser) {
                            loadUserDashboard(currentUser.uid);
                        }
                    }
                });
            });
        }

        // Form submission
        function initFormHandling() {
            const form = document.getElementById('prayerForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const title = form.querySelector('input[type="text"]').value.trim();
                    const description = form.querySelector('textarea').value.trim();
                    const category = form.querySelector('select').value || 'general';
                    const urgency = form.querySelectorAll('select')[1]?.value || 'ongoing';
                    const isAnonymous = document.getElementById('anonymous')?.checked || false;

                    if (!title) { 
                        showError('Please provide a title for your prayer request.'); 
                        return; 
                    }

                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                    submitBtn.disabled = true;

                    try {
                        const prayerData = {
                            userId: currentUser ? currentUser.uid : null,
                            userDisplayName: currentUser ? (currentUser.displayName || currentUser.email || 'User') : 'Guest',
                            userEmail: currentUser ? currentUser.email : null,
                            title: title, 
                            description: description, 
                            category: category, 
                            urgency: urgency, 
                            isAnonymous: isAnonymous,
                            status: 'open',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            privacy: isAnonymous ? 'anonymous' : 'public',
                            prayedCount: 0,
                            commentCount: 0
                        };

                        await db.collection('prayers').add(prayerData);
                        
                        showSuccess('Prayer request submitted successfully!');
                        form.reset();
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        
                        // Switch to feed tab
                        document.querySelector('[data-tab="feedTab"]').click();
                        
                    } catch (e) { 
                        console.error('Prayer submission error:', e);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        showError('Failed to submit prayer. Please try again.'); 
                    }
                });
            }
            
            // Wire up navbar and hero buttons
            document.getElementById('hero-view-wall')?.addEventListener('click', () => {
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-wall-link')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-submit-btn')?.addEventListener('click', () => {
                document.querySelector('[data-tab="submitTab"]').click();
            });
            
            // Settings modal
            const modal = document.getElementById('settings-modal');
            document.getElementById('notif-settings-btn')?.addEventListener('click', () => {
                modal.style.display = 'flex';
            });
            document.getElementById('settings-close')?.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }

        // Update user statistics
        function updateUserStats(uid) {
            if (!uid || !db) return;
            
            // Prayers shared
            db.collection('prayers').where('userId', '==', uid).onSnapshot(snapshot => {
                document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = snapshot.size;
            });
            
            // Prayers prayed (using collectionGroup)
            db.collectionGroup('interactions')
                .where('type', '==', 'prayed')
                .where('userId', '==', uid)
                .get()
                .then(snapshot => {
                    document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = snapshot.size;
                });
            
            // Answered prayers
            db.collection('prayers')
                .where('userId', '==', uid)
                .where('status', '==', 'answered')
                .onSnapshot(snapshot => {
                    document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = snapshot.size;
                });
        }

        // Load user dashboard
        function loadUserDashboard(uid) {
            if (!uid || !db) return;
            
            const userPrayersContainer = document.getElementById('user-prayers-container');
            const answeredPrayersContainer = document.getElementById('answered-prayers-container');
            
            // Load user's prayers
            db.collection('prayers')
                .where('userId', '==', uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        userPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">You haven\'t submitted any prayers yet.</div>';
                        return;
                    }
                    
                    userPrayersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const prayerDiv = document.createElement('div');
                        prayerDiv.className = 'prayer-request';
                        prayerDiv.innerHTML = `
                            <div class="prayer-user">
                                <div class="avatar">You</div>
                                <div class="user-info">
                                    <div class="user-name">You</div>
                                    <div class="request-time">${p.createdAt ? new Date(p.createdAt.toDate()).toLocaleDateString() : 'Recently'}</div>
                                </div>
                                <div class="urgency-tag ${p.urgency ? `urgency-${p.urgency}` : ''}">${p.urgency || 'General'}</div>
                            </div>
                            <div class="prayer-content">
                                <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                                <div class="prayer-description">${p.description || ''}</div>
                            </div>
                            <div class="prayer-meta">
                                <div class="category-tag">${p.category || 'General'}</div>
                            </div>`;
                        userPrayersContainer.appendChild(prayerDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading prayers:', error);
                    userPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading prayers.</div>';
                });
            
            // Load answered prayers
            db.collection('prayers')
                .where('status', '==', 'answered')
                .orderBy('answeredAt', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        answeredPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No answered prayers to show yet.</div>';
                        return;
                    }
                    
                    answeredPrayersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const isOwn = p.userId === uid;
                        const prayerDiv = document.createElement('div');
                        prayerDiv.className = 'prayer-request';
                        prayerDiv.innerHTML = `
                            <div class="prayer-user">
                                <div class="avatar">${isOwn ? 'You' : (p.userDisplayName || 'User').substring(0,2)}</div>
                                <div class="user-info">
                                    <div class="user-name">${isOwn ? 'You' : (p.userDisplayName || 'User')}</div>
                                    <div class="request-time">Answered ${p.answeredAt ? new Date(p.answeredAt.toDate()).toLocaleDateString() : 'recently'}</div>
                                </div>
                            </div>
                            <div class="prayer-content">
                                <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                                <div class="prayer-description">${p.description || ''}</div>
                            </div>
                            <div class="prayer-meta">
                                <div class="category-tag">${p.category || 'General'}</div>
                                <div style="color: var(--success); font-weight: 600;">✓ Answered</div>
                            </div>`;
                        answeredPrayersContainer.appendChild(prayerDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading answered prayers:', error);
                    answeredPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading answered prayers.</div>';
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTabNavigation();
            initFormHandling();
            
            // Show default tab (Feed)
            const defaultTab = document.getElementById('feedTab');
            if (defaultTab) {
                defaultTab.classList.add('active');
                defaultTab.style.display = 'flex';
                defaultTab.style.flexDirection = 'column';
                defaultTab.style.gap = '15px';
            }
            
            // Firebase authentication listener
            if (auth && db) {
                setLoading(true);
                
                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    const uid = user ? user.uid : null;
                    
                    // Update UI based on auth state
                    if (user) {
                        console.log('User signed in:', user.email);
                        updateUserStats(uid);
                    } else {
                        console.log('No user signed in');
                    }
                    
                    // Load prayers feed
                    if (activeUnsub) {
                        activeUnsub();
                        activeUnsub = null;
                    }
                    
                    activeUnsub = db.collection('prayers')
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .onSnapshot(snapshot => {
                            setLoading(false);
                            const docs = snapshot.docs.filter(doc => {
                                const p = doc.data();
                                // Show public and anonymous prayers to everyone
                                // Only show private prayers to their owner
                                if (p.privacy === 'private') {
                                    return uid && p.userId === uid;
                                }
                                return true;
                            });
                            renderPrayers(docs, uid);
                        }, error => {
                            setLoading(false);
                            console.error('Error loading prayers:', error);
                            showError('Failed to load prayers. Please refresh the page.');
                        });
                });
            } else {
                console.error('Firebase not initialized properly');
                showError('Unable to connect to prayer network. Please refresh the page.');
            }
        });
    </script>
</body>
</html>

