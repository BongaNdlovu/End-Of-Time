<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Diagnostics - End of Time</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #8B0000;
        }
        .success { border-left-color: #4CAF50; }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        .info { border-left-color: #2196F3; }
        button {
            background: #8B0000;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #a00000;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
        .status-info { background: #2196F3; }
        .log-output {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B0000, #ff4444);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üåê Network Diagnostics Tool</h1>
    <p>This tool will help diagnose the network connectivity issues you're experiencing with Firebase.</p>
    
    <div class="test-section info">
        <h3>üîç Current Issues Detected</h3>
        <ul>
            <li>‚ùå Firestore backend unreachable</li>
            <li>‚ùå WebChannel transport errors</li>
            <li>‚ùå Client operating in offline mode</li>
            <li>‚ö†Ô∏è Some resource loading failures</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>üß™ Network Tests</h3>
        <button onclick="runBasicConnectivityTests()">Test Basic Connectivity</button>
        <button onclick="runFirebaseSpecificTests()">Test Firebase Services</button>
        <button onclick="runAdvancedDiagnostics()">Advanced Diagnostics</button>
        <button onclick="clearLogs()">Clear Logs</button>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-bar"></div>
        </div>
        
        <div class="log-output" id="log-output"></div>
    </div>
    
    <div class="test-section">
        <h3>üìä Test Results</h3>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h3>üîß Troubleshooting Steps</h3>
        <div id="troubleshooting-steps"></div>
    </div>
    
    <script>
        let testResults = {};
        let logOutput = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logOutput.push({ message: logEntry, type });
            
            const logElement = document.getElementById('log-output');
            logElement.innerHTML = logOutput.map(entry => 
                `<div style="color: ${getColorForType(entry.type)};">${entry.message}</div>`
            ).join('');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function getColorForType(type) {
            switch(type) {
                case 'success': return '#4CAF50';
                case 'error': return '#f44336';
                case 'warning': return '#ff9800';
                default: return '#fff';
            }
        }
        
        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }
        
        function clearLogs() {
            logOutput = [];
            document.getElementById('log-output').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('troubleshooting-steps').innerHTML = '';
            updateProgress(0);
        }
        
        async function runBasicConnectivityTests() {
            clearLogs();
            log('üöÄ Starting Basic Connectivity Tests...', 'info');
            updateProgress(10);
            
            const tests = [
                { name: 'Google DNS', url: 'https://8.8.8.8', type: 'ping' },
                { name: 'Google.com', url: 'https://www.google.com', type: 'fetch' },
                { name: 'Firebase.com', url: 'https://firebase.google.com', type: 'fetch' },
                { name: 'Firestore API', url: 'https://firestore.googleapis.com', type: 'fetch' },
                { name: 'Google APIs', url: 'https://www.googleapis.com', type: 'fetch' }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                log(`Testing ${test.name}...`, 'info');
                
                try {
                    if (test.type === 'fetch') {
                        const response = await fetch(test.url, { 
                            mode: 'no-cors',
                            cache: 'no-cache'
                        });
                        testResults[test.name] = 'success';
                        log(`‚úÖ ${test.name}: Connected successfully`, 'success');
                    } else {
                        // For ping-like tests, we'll just check if we can reach the domain
                        const response = await fetch(test.url, { 
                            mode: 'no-cors',
                            cache: 'no-cache'
                        });
                        testResults[test.name] = 'success';
                        log(`‚úÖ ${test.name}: Reachable`, 'success');
                    }
                } catch (error) {
                    testResults[test.name] = 'error';
                    log(`‚ùå ${test.name}: Failed - ${error.message}`, 'error');
                }
                
                updateProgress(10 + ((i + 1) / tests.length) * 40);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            updateProgress(50);
            displayTestResults();
        }
        
        async function runFirebaseSpecificTests() {
            log('üî• Starting Firebase-Specific Tests...', 'info');
            updateProgress(50);
            
            // Test Firebase SDK loading
            if (typeof firebase !== 'undefined') {
                testResults['Firebase SDK'] = 'success';
                log('‚úÖ Firebase SDK: Loaded successfully', 'success');
            } else {
                testResults['Firebase SDK'] = 'error';
                log('‚ùå Firebase SDK: Not loaded', 'error');
            }
            
            // Test Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyAKExnN5p_QiS7iX-2x4S8Ttf7cPQ_U72E",
                authDomain: "end-of-time.firebaseapp.com",
                projectId: "end-of-time",
                storageBucket: "end-of-time.appspot.com",
                messagingSenderId: "361998196975",
                appId: "1:361998196975:web:a2c3dabc5c8a760868bb1a"
            };
            
            if (firebaseConfig.apiKey && firebaseConfig.projectId) {
                testResults['Firebase Config'] = 'success';
                log('‚úÖ Firebase Config: Valid configuration', 'success');
            } else {
                testResults['Firebase Config'] = 'error';
                log('‚ùå Firebase Config: Invalid configuration', 'error');
            }
            
            // Test Firebase project accessibility
            try {
                const response = await fetch(`https://${firebaseConfig.projectId}.firebaseapp.com`, { 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                testResults['Firebase Project'] = 'success';
                log('‚úÖ Firebase Project: Accessible', 'success');
            } catch (error) {
                testResults['Firebase Project'] = 'error';
                log('‚ùå Firebase Project: Not accessible', 'error');
            }
            
            updateProgress(80);
            displayTestResults();
        }
        
        async function runAdvancedDiagnostics() {
            log('üî¨ Starting Advanced Diagnostics...', 'info');
            updateProgress(80);
            
            // Test browser capabilities
            const browserTests = {
                'WebSocket Support': typeof WebSocket !== 'undefined',
                'Fetch API': typeof fetch !== 'undefined',
                'Service Worker': 'serviceWorker' in navigator,
                'IndexedDB': typeof indexedDB !== 'undefined',
                'Local Storage': typeof localStorage !== 'undefined'
            };
            
            for (const [test, supported] of Object.entries(browserTests)) {
                if (supported) {
                    testResults[test] = 'success';
                    log(`‚úÖ ${test}: Supported`, 'success');
                } else {
                    testResults[test] = 'error';
                    log(`‚ùå ${test}: Not supported`, 'error');
                }
            }
            
            // Test network conditions
            if ('connection' in navigator) {
                const connection = navigator.connection;
                log(`üì° Network Type: ${connection.effectiveType || 'unknown'}`, 'info');
                log(`üì∂ Downlink: ${connection.downlink || 'unknown'} Mbps`, 'info');
                log(`‚è±Ô∏è RTT: ${connection.rtt || 'unknown'} ms`, 'info');
            } else {
                log('‚ö†Ô∏è Network Information API not available', 'warning');
            }
            
            // Test for common blockers
            const blockerTests = [
                { name: 'Ad Blockers', test: () => window.adsbygoogle === undefined },
                { name: 'Privacy Extensions', test: () => window.trustedTypes === undefined },
                { name: 'Corporate Firewall', test: () => true } // This is hard to detect
            ];
            
            for (const blockerTest of blockerTests) {
                if (blockerTest.test()) {
                    testResults[blockerTest.name] = 'warning';
                    log(`‚ö†Ô∏è ${blockerTest.name}: May be interfering`, 'warning');
                } else {
                    testResults[blockerTest.name] = 'success';
                    log(`‚úÖ ${blockerTest.name}: No interference detected`, 'success');
                }
            }
            
            updateProgress(100);
            displayTestResults();
            generateTroubleshootingSteps();
        }
        
        function displayTestResults() {
            const resultsDiv = document.getElementById('test-results');
            const successCount = Object.values(testResults).filter(r => r === 'success').length;
            const errorCount = Object.values(testResults).filter(r => r === 'error').length;
            const warningCount = Object.values(testResults).filter(r => r === 'warning').length;
            
            let html = `
                <h4>üìä Test Summary</h4>
                <p>
                    <span class="status-indicator status-success"></span>Success: ${successCount} |
                    <span class="status-indicator status-error"></span>Errors: ${errorCount} |
                    <span class="status-indicator status-warning"></span>Warnings: ${warningCount}
                </p>
                <h4>üìã Detailed Results</h4>
            `;
            
            for (const [test, result] of Object.entries(testResults)) {
                const statusClass = `status-${result}`;
                const statusText = result === 'success' ? '‚úÖ' : result === 'error' ? '‚ùå' : '‚ö†Ô∏è';
                html += `<div><span class="status-indicator ${statusClass}"></span>${statusText} ${test}</div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function generateTroubleshootingSteps() {
            const stepsDiv = document.getElementById('troubleshooting-steps');
            const errorCount = Object.values(testResults).filter(r => r === 'error').length;
            
            let html = '<h4>üîß Recommended Actions</h4>';
            
            if (errorCount === 0) {
                html += '<p>‚úÖ All tests passed! Your network should be working fine.</p>';
            } else {
                html += `
                    <ol>
                        <li><strong>Check Internet Connection</strong>
                            <ul>
                                <li>Try accessing other websites</li>
                                <li>Test with a different network (mobile hotspot)</li>
                                <li>Restart your router/modem</li>
                            </ul>
                        </li>
                        <li><strong>Browser Issues</strong>
                            <ul>
                                <li>Clear browser cache and cookies</li>
                                <li>Try incognito/private mode</li>
                                <li>Disable browser extensions temporarily</li>
                                <li>Try a different browser</li>
                            </ul>
                        </li>
                        <li><strong>Network/Firewall Issues</strong>
                            <ul>
                                <li>Check if corporate firewall is blocking Firebase</li>
                                <li>Disable antivirus/firewall temporarily</li>
                                <li>Check DNS settings (try 8.8.8.8 or 1.1.1.1)</li>
                            </ul>
                        </li>
                        <li><strong>Firebase-Specific</strong>
                            <ul>
                                <li>Verify Firebase project is active in console</li>
                                <li>Check if Firestore database is created</li>
                                <li>Verify security rules are published</li>
                            </ul>
                        </li>
                    </ol>
                `;
            }
            
            stepsDiv.innerHTML = html;
        }
        
        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                runBasicConnectivityTests();
            }, 1000);
        });
    </script>
</body>
</html> 