<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Time Prayer Network</title>
    <link rel="stylesheet" href="prayer-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <video id="background-video" src="background.mp4" autoplay loop muted playsinline></video>
    <div class="app-container">
        <!-- Horizontal Nav -->
        <nav class="navbar">
            <div class="nav-brand">
                <img src="Fear God.png" alt="Fear God Imprints Logo" class="logo logo-pulse" style="height:28px;">
                <span class="title">End of Time Prayer Network</span>
            </div>
            <div class="nav-links">
                <a href="#" id="nav-home-link">Home</a>
                <a href="#" id="nav-about-link">My Prayers</a>
                <a href="#" id="nav-wall-link">Prayer Wall</a>
            </div>
            <div class="nav-cta">
                <button class="cta-btn" id="hub-menu-btn" title="Back to Hub"><i class="fas fa-home"></i></button>
                <div style="position:relative;">
                    <button class="notif-btn" id="notif-bell"><i class="fas fa-bell"></i><span class="notif-badge" id="notif-count" style="display:none;">0</span></button>
                    <div class="notif-panel" id="notif-panel"></div>
                </div>
                <button class="cta-btn" id="notif-settings-btn" title="Notification Settings"><i class="fas fa-sliders-h"></i></button>
                <button class="cta-btn" id="nav-submit-btn">Submit Prayer</button>
                <button class="cta-btn" id="signout-btn" title="Sign Out" style="display:none;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <!-- Hero -->
        <section class="hero">
            <h1>A <span class="accent">Global Community</span> United in <span class="accent">Prayer</span></h1>
            <p>In these final moments, let us stand together. Share your burdens, lift up others, and find strength in our collective faith.</p>
            <div class="hero-cta">
                <button class="pill-btn" id="hero-view-wall">View the Prayer Wall</button>
            </div>
        </section>

        <!-- Notification Settings Modal -->
        <div class="modal-backdrop" id="settings-modal" style="display:none;">
            <div class="modal-card">
                <div class="modal-header">
                    <div class="modal-title">Notification Settings</div>
                    <button class="close-x" id="settings-close">Close</button>
                </div>
                <div class="form-row">
                    <label for="settings-email">Email</label>
                    <input type="email" id="settings-email" placeholder="you@example.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;">
                </div>
                <div class="form-row">
                    <label>Enable Email Alerts</label>
                    <label class="switch"><input type="checkbox" id="settings-notify-email"> <span>Get email when someone prays for you</span></label>
                </div>
                <div class="form-row">
                    <label>Weekly Summary</label>
                    <label class="switch"><input type="checkbox" id="settings-weekly-summary"> <span>Receive weekly prayer summary</span></label>
                </div>
                <div class="form-row">
                    <label>Enable Push Alerts</label>
                    <label class="switch"><input type="checkbox" id="settings-notify-push"> <span>Browser notifications</span></label>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
                    <button class="save-btn" id="settings-save">Save</button>
                </div>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div class="modal-backdrop" id="auth-modal" style="display:flex;">
            <div class="modal-card">
                <div class="modal-header">
                    <div class="modal-title">Sign In to Prayer Network</div>
                </div>
                <div id="auth-content">
                    <!-- Sign In Form -->
                    <div id="signin-form">
                        <div class="form-row">
                            <label for="signin-email">Email</label>
                            <input type="email" id="signin-email" placeholder="your@email.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signin-password">Password</label>
                            <input type="password" id="signin-password" placeholder="Your password" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px;">
                            <button class="save-btn" id="signin-btn">Sign In</button>
                            <button class="save-btn" id="show-signup" style="background:transparent;border:1px solid var(--border);">Create Account</button>
                        </div>
                    </div>

                    <!-- Sign Up Form -->
                    <div id="signup-form" style="display:none;">
                        <div class="form-row">
                            <label for="signup-name">Display Name</label>
                            <input type="text" id="signup-name" placeholder="Your name" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" placeholder="your@email.com" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" placeholder="Choose a password" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div class="form-row">
                            <label for="signup-confirm">Confirm Password</label>
                            <input type="password" id="signup-confirm" placeholder="Confirm password" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:#333;color:#fff;" required>
                        </div>
                        <div style="display:flex; justify-content:space-between; gap:10px; margin-top:12px;">
                            <button class="save-btn" id="signup-btn">Create Account</button>
                            <button class="save-btn" id="show-signin" style="background:transparent;border:1px solid var(--border);">Back to Sign In</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Prayer Feed Tab -->
            <div class="tab-content active" id="feedTab">
                <!-- Stats Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Your Spiritual Growth</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Prayers Shared</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Prayers Prayed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Answered</div>
                        </div>
                    </div>
                </div>
                
                <!-- Streak Card -->
                <div class="card">
                    <div class="streak-container">
                        <div class="streak-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="streak-info">
                            <div class="streak-title">Current Prayer Streak</div>
                            <div class="streak-count">0 Days</div>
                            <div class="streak-desc">Keep praying to maintain your streak!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Prayer requests will be dynamically added here -->
            </div>
            
            <!-- Submit Prayer Tab -->
            <div class="tab-content" id="submitTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Share Your Prayer Request</div>
                    </div>
                    <form id="prayerForm">
                        <div class="form-group">
                            <label class="form-label">Prayer Title</label>
                            <input type="text" class="form-input" placeholder="Brief description of your request" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prayer Description</label>
                            <textarea class="form-textarea" placeholder="Share more details about your request..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select">
                                <option value="">Select a category</option>
                                <option value="health">Health</option>
                                <option value="family">Family</option>
                                <option value="spiritual">Spiritual Growth</option>
                                <option value="financial">Financial</option>
                                <option value="career">Career</option>
                                <option value="mission">Mission/Outreach</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Urgency Level</label>
                            <select class="form-select">
                                <option value="ongoing">Ongoing</option>
                                <option value="week">This Week</option>
                                <option value="immediate">Immediate</option>
                            </select>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="anonymous">
                            <label for="anonymous">Submit anonymously</label>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Submit Prayer Request
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboardTab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Your Prayer History</div>
                    </div>
                    <div id="user-prayers-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading your prayers...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Answered Prayers</div>
                    </div>
                    <div id="answered-prayers-container">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading answered prayers...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="feedTab">
                <i class="fas fa-home"></i>
                <div>Feed</div>
            </div>
            <div class="nav-tab" data-tab="submitTab">
                <i class="fas fa-plus-circle"></i>
                <div>Submit</div>
            </div>
            <div class="nav-tab" data-tab="dashboardTab">
                <i class="fas fa-chart-line"></i>
                <div>Dashboard</div>
            </div>
        </div>
    </div>

    <script>
        // Suppress browser extension errors
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes('chrome-extension://')) {
                e.preventDefault();
                return true;
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.toString().includes('chrome-extension')) {
                e.preventDefault();
                return true;
            }
        });

        // Handle any message events properly
        if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.onMessage) {
            chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
                return true;
            });
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA78bvzjP-b7K9TPCbIL3ttzPJr07VR8kY",
            authDomain: "end-of-time-94cd3.firebaseapp.com",
            projectId: "end-of-time-94cd3",
            storageBucket: "end-of-time-94cd3.firebasestorage.app",
            messagingSenderId: "628602476853",
            appId: "1:628602476853:web:181df03c3374465811147c",
            measurementId: "G-E5R3NG1533"
        };

        let auth, db;
        let currentUser = null;
        let activeUnsub = null;
        
        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('✅ Firebase initialized for Prayer Network');
        } catch (e) {
            console.error('❌ Firebase initialization failed:', e);
        }

        // Authentication Functions
        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        function initAuth() {
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const showSignup = document.getElementById('show-signup');
            const showSignin = document.getElementById('show-signin');
            const signinBtn = document.getElementById('signin-btn');
            const signupBtn = document.getElementById('signup-btn');
            const signoutBtn = document.getElementById('signout-btn');

            // Toggle between signin and signup forms
            showSignup.addEventListener('click', () => {
                signinForm.style.display = 'none';
                signupForm.style.display = 'block';
            });

            showSignin.addEventListener('click', () => {
                signupForm.style.display = 'none';
                signinForm.style.display = 'block';
            });

            // Sign in functionality
            signinBtn.addEventListener('click', async () => {
                const email = document.getElementById('signin-email').value.trim();
                const password = document.getElementById('signin-password').value;

                if (!email || !password) {
                    showError('Please enter both email and password');
                    return;
                }

                signinBtn.disabled = true;
                signinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showSuccess('Welcome back! You are now signed in.');
                    hideAuthModal();
                } catch (error) {
                    console.error('Sign in error:', error);
                    showError(getAuthErrorMessage(error.code));
                } finally {
                    signinBtn.disabled = false;
                    signinBtn.innerHTML = 'Sign In';
                }
            });

            // Sign up functionality
            signupBtn.addEventListener('click', async () => {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm').value;

                if (!name || !email || !password || !confirmPassword) {
                    showError('Please fill in all fields');
                    return;
                }

                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }

                if (password.length < 6) {
                    showError('Password must be at least 6 characters long');
                    return;
                }

                signupBtn.disabled = true;
                signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    
                    // Create user document in Firestore
                    await db.collection('users').doc(userCredential.user.uid).set({
                        displayName: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        notifyEmail: true,
                        weeklySummary: true,
                        notifyPush: true
                    });

                    showSuccess('Account created successfully! Welcome to the Prayer Network.');
                    hideAuthModal();
                } catch (error) {
                    console.error('Sign up error:', error);
                    showError(getAuthErrorMessage(error.code));
                } finally {
                    signupBtn.disabled = false;
                    signupBtn.innerHTML = 'Create Account';
                }
            });

            // Sign out functionality
            signoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    showSuccess('You have been signed out');
                } catch (error) {
                    console.error('Sign out error:', error);
                    showError('Failed to sign out');
                }
            });
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address';
                case 'auth/wrong-password':
                    return 'Incorrect password';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists';
                case 'auth/weak-password':
                    return 'Password is too weak';
                case 'auth/invalid-email':
                    return 'Invalid email address';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later';
                default:
                    return 'Authentication failed. Please try again';
            }
        }

        function updateUIForAuthState(user) {
            const authModal = document.getElementById('auth-modal');
            const signoutBtn = document.getElementById('signout-btn');
            const navSubmitBtn = document.getElementById('nav-submit-btn');
            const navSettingsBtn = document.getElementById('notif-settings-btn');

            if (user) {
                // User is signed in
                authModal.style.display = 'none';
                signoutBtn.style.display = 'block';
                navSubmitBtn.style.display = 'block';
                navSettingsBtn.style.display = 'block';
            } else {
                // User is signed out
                authModal.style.display = 'flex';
                signoutBtn.style.display = 'none';
                navSubmitBtn.style.display = 'none';
                navSettingsBtn.style.display = 'none';
            }
        }

        // UI Helper Functions
        function setLoading(isLoading) {
            const area = document.getElementById('contentArea');
            if (isLoading) {
                area.setAttribute('aria-busy', 'true');
            } else {
                area.removeAttribute('aria-busy');
            }
        }
        
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            toast.innerHTML = `<i class="fas fa-check" style="margin-right: 8px;"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showError(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            toast.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Email notification function (client-side trigger)
        async function sendEmailNotification(recipientUserId, type, data) {
            if (!recipientUserId) return;
            
            try {
                // Get recipient's email preferences
                const userDoc = await db.collection('users').doc(recipientUserId).get();
                const userData = userDoc.data();
                
                if (userData && userData.notifyEmail && userData.email) {
                    // Store email notification request in Firestore for backend processing
                    await db.collection('emailQueue').add({
                        to: userData.email,
                        type: type,
                        data: data,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    });
                    console.log('Email notification queued');
                }
            } catch (e) {
                console.log('Could not queue email notification:', e);
            }
        }

        // Render prayers function with comments fix
        function renderPrayers(snapshotDocs, currentUid) {
            const feed = document.getElementById('feedTab');
            
            // Keep the first two cards (stats and streak)
            const staticCards = feed.querySelectorAll('.card');
            const cardsToKeep = Array.from(staticCards).slice(0, 2);
            
            // Clear everything else
            feed.innerHTML = '';
            cardsToKeep.forEach(card => feed.appendChild(card));

            if (snapshotDocs.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'card';
                emptyState.style.textAlign = 'center';
                emptyState.style.padding = '40px';
                emptyState.innerHTML = `
                    <i class="fas fa-praying-hands" style="font-size: 3rem; color: #999; margin-bottom: 1rem;"></i>
                    <p style="color: #999; font-size: 1.1rem;">No prayers yet. Be the first to share!</p>
                `;
                feed.appendChild(emptyState);
                return;
            }

            snapshotDocs.forEach(doc => {
                const p = doc.data();
                const isOwner = p.userId === currentUid;
                const isAnon = p.isAnonymous === true && !isOwner;
                const displayName = isAnon ? 'Anonymous' : (p.userDisplayName || 'User');

                const wrapper = document.createElement('div');
                wrapper.className = 'prayer-request card' + (isAnon ? ' anonymous' : '');
                wrapper.innerHTML = `
                    <div class="prayer-user">
                        <div class="avatar">${(displayName||'U').substring(0,2)}</div>
                        <div class="user-info">
                            <div class="user-name">${displayName}</div>
                            <div class="request-time">${p.createdAt ? new Date(p.createdAt.toDate()).toLocaleString() : 'Just now'}</div>
                        </div>
                        <div class="urgency-tag ${p.urgency ? `urgency-${p.urgency}`: ''}">${p.urgency || 'General'}</div>
                    </div>
                    <div class="prayer-content">
                        <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                        <div class="prayer-description">${p.description || ''}</div>
                    </div>
                    <div class="prayer-meta">
                        <div class="category-tag">${p.category || 'General'}</div>
                        ${p.status === 'answered' ? '<div style="color: var(--success); font-weight: 600;">✓ Answered</div>' : ''}
                    </div>
                    <div class="prayer-actions">
                        <button class="action-btn pray-btn"><i class="fas fa-pray"></i> I Prayed (<span class="pray-count">0</span>)</button>
                        <button class="action-btn toggle-comments"><i class="fas fa-comment"></i> Comments (<span class="comment-count">0</span>)</button>
                        ${isOwner 
                            ? `<button class="action-btn toggle-status">${p.status === 'answered' ? '<i class="fas fa-undo"></i> Mark Ongoing' : '<i class="fas fa-check-circle"></i> Mark Answered'}</button>
                               <button class="action-btn delete-prayer" style="background: rgba(231,76,60,0.2); color: #e74c3c; border-color: #e74c3c;"><i class="fas fa-trash"></i> Delete</button>`
                            : ''}
                    </div>
                    <div class="comments-container" style="display:none;margin-top:10px;">
                        <div class="comments-list" style="background: rgba(255,255,255,0.05); padding:10px; border-radius:8px; border:1px solid var(--border); max-height: 200px; overflow-y: auto;"></div>
                        <form class="comment-form" style="display:flex; gap:8px; margin-top:8px;">
                            <input type="text" placeholder="Write a comment..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:#333; color:#fff;">
                            <button class="action-btn" type="submit" style="flex:0 0 auto;">Post</button>
                        </form>
                    </div>`;

                // Wire up the pray button
                const prayBtn = wrapper.querySelector('.pray-btn');
                const prayCount = wrapper.querySelector('.pray-count');
                const commentCount = wrapper.querySelector('.comment-count');
                
                // Update pray count
                db.collection('prayers').doc(doc.id).collection('interactions')
                    .where('type', '==', 'prayed')
                    .onSnapshot(snapshot => {
                        prayCount.textContent = snapshot.size;
                    });

                // Update comment count
                db.collection('prayers').doc(doc.id).collection('interactions')
                    .where('type', '==', 'comment')
                    .onSnapshot(snapshot => {
                        commentCount.textContent = snapshot.size;
                    });

                // Check if current user already prayed
                if (currentUid) {
                    db.collection('prayers').doc(doc.id).collection('interactions')
                        .where('type', '==', 'prayed')
                        .where('userId', '==', currentUid)
                        .get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                prayBtn.innerHTML = '<i class="fas fa-check"></i> You Prayed (<span class="pray-count">0</span>)';
                                prayBtn.classList.add('answered');
                                prayBtn.disabled = true;
                            }
                        });
                }

                prayBtn.addEventListener('click', async () => {
                    if (prayBtn.disabled) return;
                    
                    prayBtn.disabled = true;
                    const originalText = prayBtn.innerHTML;
                    prayBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Praying...';

                    try {
                        const userName = currentUser ? (currentUser.displayName || currentUser.email || 'Anonymous') : 'Anonymous';
                        
                        await db.collection('prayers').doc(doc.id).collection('interactions').add({
                            type: 'prayed',
                            userId: currentUid || null,
                            userDisplayName: userName,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        
                        prayBtn.innerHTML = '<i class="fas fa-check"></i> You Prayed (<span class="pray-count">0</span>)';
                        prayBtn.classList.add('answered');
                        
                        showSuccess('Thank you for your prayers! God bless you.');
                        
                        // Create notification and trigger email
                        if (p.userId && p.userId !== currentUid) {
                            try {
                                await db.collection('notifications').add({
                                    userId: p.userId,
                                    type: 'prayed',
                                    prayerId: doc.id,
                                    prayerTitle: p.title,
                                    actorId: currentUid || null,
                                    actorName: userName,
                                    message: `${userName} is praying for your request: "${p.title}"`,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    read: false,
                                });
                                
                                // Send email notification
                                await sendEmailNotification(p.userId, 'prayer_received', {
                                    prayerTitle: p.title,
                                    userName: userName,
                                    message: `${userName} is lifting you up in prayer for "${p.title}". You are not alone in this journey.`
                                });
                            } catch(e) {
                                console.log('Notification creation failed:', e);
                            }
                        }
                    } catch (e) {
                        console.error('Prayer interaction error:', e);
                        prayBtn.innerHTML = originalText;
                        prayBtn.disabled = false;
                        showError('Unable to record your prayer. Please try again.');
                    }
                });

                // Toggle status button for owners
                const toggleStatus = wrapper.querySelector('.toggle-status');
                if (toggleStatus) {
                    toggleStatus.addEventListener('click', async () => {
                        try {
                            const newStatus = p.status === 'answered' ? 'ongoing' : 'answered';
                            await db.collection('prayers').doc(doc.id).update({ 
                                status: newStatus, 
                                answeredAt: newStatus === 'answered' ? firebase.firestore.FieldValue.serverTimestamp() : null,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            showSuccess(`Prayer marked as ${newStatus}`);
                            toggleStatus.innerHTML = newStatus === 'answered' 
                                ? '<i class="fas fa-undo"></i> Mark Ongoing' 
                                : '<i class="fas fa-check-circle"></i> Mark Answered';
                        } catch (e) { 
                            console.error(e); 
                            showError('Failed to update status'); 
                        }
                    });
                }

                // Delete button for owners
                const deleteBtn = wrapper.querySelector('.delete-prayer');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this prayer request? This action cannot be undone.')) {
                            try {
                                // Delete all interactions first
                                const interactions = await db.collection('prayers').doc(doc.id).collection('interactions').get();
                                const batch = db.batch();
                                interactions.forEach(interDoc => {
                                    batch.delete(interDoc.ref);
                                });
                                await batch.commit();
                                
                                // Then delete the prayer
                                await db.collection('prayers').doc(doc.id).delete();
                                showSuccess('Prayer request deleted successfully');
                            } catch (e) {
                                console.error('Delete error:', e);
                                showError('Failed to delete prayer request');
                            }
                        }
                    });
                }

                // Comments functionality
                const commentsContainer = wrapper.querySelector('.comments-container');
                const toggleComments = wrapper.querySelector('.toggle-comments');
                const commentsList = wrapper.querySelector('.comments-list');
                const commentForm = wrapper.querySelector('.comment-form');
                // use existing commentCount from outer scope
                
                // Load and display comments
                let commentsLoaded = false;
                
                function loadComments() {
                    db.collection('prayers').doc(doc.id).collection('interactions')
                        .where('type', '==', 'comment')
                        .orderBy('createdAt', 'asc')
                        .onSnapshot(snapshot => {
                            commentCount.textContent = snapshot.size;
                            commentsList.innerHTML = '';
                            
                            if (snapshot.empty) {
                                commentsList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">No comments yet. Be the first to encourage!</div>';
                            } else {
                                snapshot.forEach(commentDoc => {
                                    const comment = commentDoc.data();
                                    const commentDiv = document.createElement('div');
                                    commentDiv.style.cssText = 'margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;';
                                    
                                    const isCommentOwner = comment.userId === currentUid;
                                    commentDiv.innerHTML = `
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div style="flex: 1;">
                                                <strong style="color: #fff;">${comment.userDisplayName || 'Anonymous'}:</strong>
                                                <span style="color: #ddd; margin-left: 5px;">${comment.text}</span>
                                            </div>
                                            ${isCommentOwner ? `
                                                <button class="delete-comment" data-id="${commentDoc.id}" style="background: transparent; border: none; color: #e74c3c; cursor: pointer; padding: 2px 6px;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #999; margin-top: 4px;">
                                            ${comment.createdAt ? new Date(comment.createdAt.toDate()).toLocaleString() : 'Just now'}
                                        </div>
                                    `;
                                    
                                    // Wire delete button if present
                                    const deleteCommentBtn = commentDiv.querySelector('.delete-comment');
                                    if (deleteCommentBtn) {
                                        deleteCommentBtn.addEventListener('click', async () => {
                                            try {
                                                await db.collection('prayers').doc(doc.id)
                                                    .collection('interactions').doc(commentDoc.id).delete();
                                                showSuccess('Comment deleted');
                                            } catch (e) {
                                                console.error('Delete comment error:', e);
                                                showError('Failed to delete comment');
                                            }
                                        });
                                    }
                                    
                                    commentsList.appendChild(commentDiv);
                                });
                            }
                        });
                }
                
                toggleComments.addEventListener('click', () => {
                    const isOpen = commentsContainer.style.display !== 'none';
                    commentsContainer.style.display = isOpen ? 'none' : 'block';
                    
                    if (!isOpen && !commentsLoaded) {
                        loadComments();
                        commentsLoaded = true;
                    }
                });
                
                // Handle comment submission
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = commentForm.querySelector('input');
                    const text = input.value.trim();
                    
                    if (!text) return;
                    
                    try {
                        const userName = currentUser ? (currentUser.displayName || currentUser.email || 'Anonymous') : 'Anonymous';
                        
                        await db.collection('prayers').doc(doc.id).collection('interactions').add({
                            type: 'comment',
                            userId: currentUid || null,
                            userDisplayName: userName,
                            text: text,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        
                        input.value = '';
                        
                        // Notify prayer owner about the comment
                        if (p.userId && p.userId !== currentUid) {
                            try {
                                await db.collection('notifications').add({
                                    userId: p.userId,
                                    type: 'comment',
                                    prayerId: doc.id,
                                    prayerTitle: p.title,
                                    actorId: currentUid || null,
                                    actorName: userName,
                                    message: `${userName} commented on your prayer: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    read: false,
                                });
                                
                                // Send email notification for comment
                                await sendEmailNotification(p.userId, 'comment_received', {
                                    prayerTitle: p.title,
                                    userName: userName,
                                    comment: text,
                                    message: `${userName} left an encouraging message on your prayer request "${p.title}".`
                                });
                            } catch(e) {
                                console.log('Comment notification failed:', e);
                            }
                        }
                    } catch (e) {
                        console.error('Comment submission error:', e);
                        showError('Failed to post comment. Please try again.');
                    }
                });

                feed.appendChild(wrapper);
            });
        }

        // Tab Navigation
        function initTabNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    const tabId = tab.getAttribute('data-tab');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                        targetTab.style.display = 'flex';
                        targetTab.style.flexDirection = 'column';
                        targetTab.style.gap = '15px';
                        
                        // Load dashboard data when switching to dashboard tab
                        if (tabId === 'dashboardTab' && currentUser) {
                            loadUserDashboard(currentUser.uid);
                        }
                    }
                });
            });
        }

        // Form submission
        function initFormHandling() {
            const form = document.getElementById('prayerForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const title = form.querySelector('input[type="text"]').value.trim();
                    const description = form.querySelector('textarea').value.trim();
                    const category = form.querySelector('select').value || 'general';
                    const urgency = form.querySelectorAll('select')[1]?.value || 'ongoing';
                    const isAnonymous = document.getElementById('anonymous')?.checked || false;

                    if (!title) { 
                        showError('Please provide a title for your prayer request.'); 
                        return; 
                    }

                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                    submitBtn.disabled = true;

                    try {
                        const prayerData = {
                            userId: currentUser ? currentUser.uid : null,
                            userDisplayName: currentUser ? (currentUser.displayName || currentUser.email || 'User') : 'Guest',
                            userEmail: currentUser ? currentUser.email : null,
                            title: title, 
                            description: description, 
                            category: category, 
                            urgency: urgency, 
                            isAnonymous: isAnonymous,
                            status: 'ongoing',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            privacy: isAnonymous ? 'anonymous' : 'public',
                            prayedCount: 0,
                            commentCount: 0
                        };

                        await db.collection('prayers').add(prayerData);
                        
                        showSuccess('Prayer request submitted successfully! The community will lift you up.');
                        form.reset();
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        
                        // Switch to feed tab
                        document.querySelector('[data-tab="feedTab"]').click();
                        
                    } catch (e) { 
                        console.error('Prayer submission error:', e);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        showError('Failed to submit prayer. Please try again.'); 
                    }
                });
            }
            
            // Wire up navbar and hero buttons
            document.getElementById('hero-view-wall')?.addEventListener('click', () => {
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-wall-link')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('[data-tab="feedTab"]').click();
            });
            
            document.getElementById('nav-about-link')?.addEventListener('click', (e) => {
                e.preventDefault();
                // Load user's prayers
                if (currentUser) {
                    loadMyPrayers(currentUser.uid);
                }
            });
            
            document.getElementById('nav-submit-btn')?.addEventListener('click', () => {
                document.querySelector('[data-tab="submitTab"]').click();
            });
            // Hub button -> go back to hub menu
            document.getElementById('hub-menu-btn')?.addEventListener('click', () => {
                window.location.href = 'menu.html';
            });
            
            // Settings modal
            const modal = document.getElementById('settings-modal');
            document.getElementById('notif-settings-btn')?.addEventListener('click', () => {
                modal.style.display = 'flex';
            });
            document.getElementById('settings-close')?.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }

        // Load only user's prayers
        function loadMyPrayers(uid) {
            if (!uid || !db) {
                showError('Please sign in to view your prayers');
                return;
            }
            
            setLoading(true);
            
            if (activeUnsub) {
                activeUnsub();
                activeUnsub = null;
            }
            
            activeUnsub = db.collection('prayers')
                .where('userId', '==', uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    setLoading(false);
                    renderPrayers(snapshot.docs, uid);
                }, error => {
                    setLoading(false);
                    console.error('Error loading your prayers:', error);
                    showError('Failed to load your prayers');
                });
        }

        // Update user statistics
        function updateUserStats(uid) {
            if (!uid || !db) return;
            
            // Prayers shared
            db.collection('prayers').where('userId', '==', uid).onSnapshot(snapshot => {
                const statCard = document.querySelector('.stat-card:nth-child(1) .stat-value');
                if (statCard) statCard.textContent = snapshot.size;
            });
            
            // Prayers prayed (using collectionGroup)
            db.collectionGroup('interactions')
                .where('type', '==', 'prayed')
                .where('userId', '==', uid)
                .get()
                .then(snapshot => {
                    const statCard = document.querySelector('.stat-card:nth-child(2) .stat-value');
                    if (statCard) statCard.textContent = snapshot.size;
                });
            
            // Answered prayers
            db.collection('prayers')
                .where('userId', '==', uid)
                .where('status', '==', 'answered')
                .onSnapshot(snapshot => {
                    const statCard = document.querySelector('.stat-card:nth-child(3) .stat-value');
                    if (statCard) statCard.textContent = snapshot.size;
                });
            
            // Update streak
            updatePrayerStreak(uid);
        }

        // Calculate prayer streak
        function updatePrayerStreak(uid) {
            if (!uid || !db) return;
            
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            db.collectionGroup('interactions')
                .where('userId', '==', uid)
                .where('type', 'in', ['prayed', 'comment'])
                .where('createdAt', '>=', sevenDaysAgo)
                .get()
                .then(snapshot => {
                    const days = new Set();
                    snapshot.forEach(doc => {
                        const date = doc.data().createdAt?.toDate();
                        if (date) {
                            days.add(date.toDateString());
                        }
                    });
                    
                    const streakElement = document.querySelector('.streak-count');
                    if (streakElement) {
                        streakElement.textContent = `${days.size} Days`;
                    }
                });
        }

        // Load user dashboard
        function loadUserDashboard(uid) {
            if (!uid || !db) return;
            
            const userPrayersContainer = document.getElementById('user-prayers-container');
            const answeredPrayersContainer = document.getElementById('answered-prayers-container');
            
            // Load user's prayers with delete and status toggle
            db.collection('prayers')
                .where('userId', '==', uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        userPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">You haven\'t submitted any prayers yet.</div>';
                        return;
                    }
                    
                    userPrayersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const prayerDiv = document.createElement('div');
                        prayerDiv.className = 'prayer-request';
                        prayerDiv.innerHTML = `
                            <div class="prayer-user">
                                <div class="avatar">You</div>
                                <div class="user-info">
                                    <div class="user-name">Your Prayer</div>
                                    <div class="request-time">${p.createdAt ? new Date(p.createdAt.toDate()).toLocaleDateString() : 'Recently'}</div>
                                </div>
                                <div class="urgency-tag ${p.urgency ? `urgency-${p.urgency}` : ''}">${p.urgency || 'General'}</div>
                            </div>
                            <div class="prayer-content">
                                <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                                <div class="prayer-description">${p.description || ''}</div>
                            </div>
                            <div class="prayer-meta">
                                <div class="category-tag">${p.category || 'General'}</div>
                                ${p.status === 'answered' ? '<div style="color: var(--success); font-weight: 600;">✓ Answered</div>' : ''}
                            </div>
                            <div class="prayer-actions">
                                <button class="action-btn status-toggle" data-id="${doc.id}" data-status="${p.status}">
                                    ${p.status === 'answered' ? '<i class="fas fa-undo"></i> Mark Ongoing' : '<i class="fas fa-check-circle"></i> Mark Answered'}
                                </button>
                                <button class="action-btn delete-btn" data-id="${doc.id}" style="background: rgba(231,76,60,0.2); color: #e74c3c; border-color: #e74c3c;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>`;
                        
                        // Wire status toggle
                        const statusBtn = prayerDiv.querySelector('.status-toggle');
                        statusBtn.addEventListener('click', async () => {
                            const newStatus = statusBtn.dataset.status === 'answered' ? 'ongoing' : 'answered';
                            try {
                                await db.collection('prayers').doc(statusBtn.dataset.id).update({
                                    status: newStatus,
                                    answeredAt: newStatus === 'answered' ? firebase.firestore.FieldValue.serverTimestamp() : null,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                showSuccess(`Prayer marked as ${newStatus}`);
                                loadUserDashboard(uid); // Reload dashboard
                            } catch (e) {
                                console.error('Status update error:', e);
                                showError('Failed to update status');
                            }
                        });
                        
                        // Wire delete button
                        const deleteBtn = prayerDiv.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', async () => {
                            if (confirm('Are you sure you want to delete this prayer? This cannot be undone.')) {
                                try {
                                    // Delete interactions first
                                    const interactions = await db.collection('prayers').doc(deleteBtn.dataset.id).collection('interactions').get();
                                    const batch = db.batch();
                                    interactions.forEach(interDoc => {
                                        batch.delete(interDoc.ref);
                                    });
                                    await batch.commit();
                                    
                                    // Delete prayer
                                    await db.collection('prayers').doc(deleteBtn.dataset.id).delete();
                                    showSuccess('Prayer deleted successfully');
                                    loadUserDashboard(uid); // Reload dashboard
                                } catch (e) {
                                    console.error('Delete error:', e);
                                    showError('Failed to delete prayer');
                                }
                            }
                        });
                        
                        userPrayersContainer.appendChild(prayerDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading prayers:', error);
                    userPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading prayers.</div>';
                });
            
            // Load community answered prayers
            db.collection('prayers')
                .where('status', '==', 'answered')
                .orderBy('answeredAt', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        answeredPrayersContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No answered prayers to celebrate yet.</div>';
                        return;
                    }
                    
                    answeredPrayersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const isOwn = p.userId === uid;
                        const prayerDiv = document.createElement('div');
                        prayerDiv.className = 'prayer-request';
                        prayerDiv.innerHTML = `
                            <div class="prayer-user">
                                <div class="avatar">${isOwn ? 'You' : (p.userDisplayName || 'User').substring(0,2)}</div>
                                <div class="user-info">
                                    <div class="user-name">${isOwn ? 'Your Prayer' : (p.userDisplayName || 'User')}</div>
                                    <div class="request-time">Answered ${p.answeredAt ? new Date(p.answeredAt.toDate()).toLocaleDateString() : 'recently'}</div>
                                </div>
                            </div>
                            <div class="prayer-content">
                                <div class="prayer-title">${p.title || 'Prayer Request'}</div>
                                <div class="prayer-description">${p.description || ''}</div>
                            </div>
                            <div class="prayer-meta">
                                <div class="category-tag">${p.category || 'General'}</div>
                                <div style="color: var(--success); font-weight: 600;">✓ Answered - Praise God!</div>
                            </div>`;
                        answeredPrayersContainer.appendChild(prayerDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading answered prayers:', error);
                    answeredPrayersContainer.innerHTML = '<div style="color: red; padding: 20px;">Error loading answered prayers.</div>';
                });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTabNavigation();
            initFormHandling();
            initAuth();
            
            // Show default tab (Feed)
            const defaultTab = document.getElementById('feedTab');
            if (defaultTab) {
                defaultTab.classList.add('active');
                defaultTab.style.display = 'flex';
                defaultTab.style.flexDirection = 'column';
                defaultTab.style.gap = '15px';
            }
            
            // Firebase authentication listener
            if (auth && db) {
                setLoading(true);
                
                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    const uid = user ? user.uid : null;
                    
                    // Update UI based on auth state
                    updateUIForAuthState(user);
                    
                    if (user) {
                        console.log('User signed in:', user.email);
                        updateUserStats(uid);
                        
                        // Load notification settings
                        db.collection('users').doc(uid).get().then(doc => {
                            const data = doc.data() || {};
                            document.getElementById('settings-email').value = data.email || user.email || '';
                            document.getElementById('settings-notify-email').checked = !!data.notifyEmail;
                            document.getElementById('settings-weekly-summary').checked = !!data.weeklySummary;
                            document.getElementById('settings-notify-push').checked = !!data.notifyPush;
                        }).catch(e => console.log('Error loading settings:', e));
                        
                        // Wire up settings save button
                        document.getElementById('settings-save').onclick = async () => {
                            const email = document.getElementById('settings-email').value.trim();
                            const notifyEmail = document.getElementById('settings-notify-email').checked;
                            const weeklySummary = document.getElementById('settings-weekly-summary').checked;
                            const notifyPush = document.getElementById('settings-notify-push').checked;
                            
                            if (email && !/\S+@\S+\.\S+/.test(email)) {
                                showError('Please enter a valid email address.');
                                return;
                            }
                            
                            try {
                                await db.collection('users').doc(uid).set({ 
                                    email, 
                                    notifyEmail, 
                                    weeklySummary,
                                    notifyPush,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: true });
                                
                                showSuccess('Settings saved successfully!');
                                document.getElementById('settings-modal').style.display = 'none';
                            } catch (error) {
                                console.error('Settings save error:', error);
                                showError('Failed to save settings. Please try again.');
                            }
                        };
                        
                        // Load notifications
                        const panel = document.getElementById('notif-panel');
                        const badge = document.getElementById('notif-count');
                        const bell = document.getElementById('notif-bell');
                        
                        let notifOpen = false;
                        bell.addEventListener('click', () => {
                            notifOpen = !notifOpen;
                            panel.style.display = notifOpen ? 'block' : 'none';
                        });
                        
                        // Listen for notifications
                        db.collection('notifications')
                            .where('userId', '==', uid)
                            .orderBy('createdAt', 'desc')
                            .limit(20)
                            .onSnapshot(snapshot => {
                                let unreadCount = 0;
                                panel.innerHTML = '';
                                
                                if (snapshot.empty) {
                                    panel.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No notifications yet</div>';
                                } else {
                                    snapshot.forEach(doc => {
                                        const n = doc.data();
                                        if (!n.read) unreadCount++;
                                        
                                        const div = document.createElement('div');
                                        div.className = 'notif-item' + (!n.read ? ' unread' : '');
                                        const timeAgo = n.createdAt ? new Date(n.createdAt.toDate()).toLocaleString() : 'Just now';
                                        
                                        div.innerHTML = `
                                            <div class="notif-text" style="font-weight: 500; margin-bottom: 4px;">${n.message || 'New notification'}</div>
                                            <div class="notif-time" style="font-size: 0.8em; color: #999; margin-bottom: 8px;">${timeAgo}</div>
                                            <div class="notif-actions">
                                                <button class="link-btn mark-read">${n.read ? 'Read' : 'Mark Read'}</button>
                                            </div>`;
                                        
                                        div.querySelector('.mark-read').addEventListener('click', () => {
                                            doc.ref.update({ read: true });
                                        });
                                        
                                        panel.appendChild(div);
                                    });
                                }
                                
                                // Update badge
                                if (unreadCount > 0) {
                                    badge.style.display = 'inline-block';
                                    badge.textContent = String(unreadCount);
                                } else {
                                    badge.style.display = 'none';
                                }
                            });
                    } else {
                        console.log('No user signed in');
                    }
                    
                    // Load prayers feed
                    if (activeUnsub) {
                        activeUnsub();
                        activeUnsub = null;
                    }
                    
                    activeUnsub = db.collection('prayers')
                        .orderBy('createdAt', 'desc')
                        .limit(50)
                        .onSnapshot(snapshot => {
                            setLoading(false);
                            const docs = snapshot.docs.filter(doc => {
                                const p = doc.data();
                                // Show public and anonymous prayers to everyone
                                // Only show private prayers to their owner
                                if (p.privacy === 'private') {
                                    return uid && p.userId === uid;
                                }
                                return true;
                            });
                            renderPrayers(docs, uid);
                        }, error => {
                            setLoading(false);
                            console.error('Error loading prayers:', error);
                            showError('Failed to load prayers. Please refresh the page.');
                        });
                });
            } else {
                console.error('Firebase not initialized properly');
                showError('Unable to connect to prayer network. Please refresh the page.');
            }
        });
    </script>
</body>
</html>

